<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>HG Acil</title>
<style>
body{font-family:sans-serif;padding:20px;margin:0;background:#fff;color:#111}
input{width:100%;padding:14px;font-size:17px;border-radius:10px;border:1px solid #777;margin-top:6px}
button{width:100%;padding:20px;font-size:18px;background:#d33;color:#fff;border:none;border-radius:12px;margin-top:12px;font-weight:600;cursor:pointer}
button.alt{background:#444}
.alert{background:#fffae0;border-left:4px solid #e6a700;padding:12px;border-radius:8px;margin-top:12px;font-size:15px}
.panel{padding:16px;background:#f4f4f4;border-radius:12px;margin-bottom:14px}
#panicBtn{background:#d33;font-size:22px;padding:26px;color:#fff;border-radius:12px;border:none;font-weight:600;margin-top:20px;width:100%}
#confirmBox{display:none;position:fixed;top:30%;left:5%;width:90%;background:#fff;padding:16px;border-radius:12px;box-shadow:0 0 16px rgba(0,0,0,0.3)}
</style>
</head>
<body>

<h2>HÄ±zÄ±r Gibi â€” ACÄ°L GÃ¼ven</h2>
<div id="alerts"></div>

<!-- Ä°zin Paneli (aktif kalÄ±yor, atlamÄ±yor) -->
<div id="permPanel" class="panel">
  <h3>Gerekli Ä°zinler</h3>
  <p>Hayati acil analiz ve anlÄ±k veri takibi iÃ§in aÅŸaÄŸÄ±daki izinleri verin:</p>
  <button onclick="requestGPS()">ğŸ“ Konum izni ver</button>
  <button onclick="requestMotion()">ğŸ“± Hareket sensÃ¶rÃ¼ izni ver</button>
  <button onclick="requestNotif()">ğŸ”” Bildirim izni ver</button>
  <button onclick="requestBT()">âŒš Bluetooth izni ver (AkÄ±llÄ± saat iÃ§in)</button>
  <button class="perm alt" onclick="allPermsDone()">Ä°zinler tamam, profile geÃ§</button>
</div>

<!-- Profil Paneli -->
<div id="profilePanel" class="panel" style="display:none">
  <h3>Acil Profil</h3>
  <label>Ad Soyad</label>
  <input id="ad" placeholder="Ad Soyad"/>
  <label style="margin-top:12px;display:block">Acil kiÅŸi telefonu</label>
  <input id="tel" placeholder="05xx xxx xx xx"/>
  <label style="margin-top:12px;display:block">Lisans kodu (trial iÃ§in boÅŸ bÄ±rak)</label>
  <input id="license" placeholder="HG-2027-12-31-XXXXX"/>
  <div id="fpBox" style="margin-top:10px;font-size:13px;color:#333"></div>
  <button onclick="activateSystem()">Kaydet & BaÅŸlat</button>
</div>

<!-- Ana Sistem Paneli -->
<div id="mainPanel" class="panel" style="display:none">
  <h3>Sistem Aktif</h3>
  <div id="status" class="alert">ğŸ“¡ Acil durum izleme sistemi hazÄ±r.</div>
  <button id="panicBtn" onclick="panicConfirm()">ACÄ°L</button>
</div>

<!-- 112 Arama OnayÄ± -->
<div id="confirmBox">
  <div id="confirmText"></div>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px">
    <button onclick="call112()">ğŸ“ 112â€™yi Ara</button>
    <button onclick="closeConfirm()" class="alt">Ä°ptal</button>
  </div>
</div>

<script>
const LS = localStorage;
let izinler = JSON.parse(LS.getItem("izinler") || '{"konum":false,"motion":false,"notif":false,"bt":false}');
LS.setItem("izinler", JSON.stringify(izinler));

// UyarÄ± bas
function warnUI(msg){
  document.getElementById("alerts").innerHTML += `<div class="alert">${msg}</div>`;
}

// Ä°zinler tamamlandÄ± â†’ profile geÃ§me butonu aktif olur ama otomatik geÃ§iÅŸ yapmaz
function allPermsDone(){
  showPanel("profilePanel");
}

// UI panel geÃ§iÅŸi (butonlarÄ± kapatmÄ±yor artÄ±k)
function showPanel(id){
  document.getElementById("permPanel").style.display="none";
  document.getElementById("profilePanel").style.display="none";
  document.getElementById("mainPanel").style.display="none";
  document.getElementById(id).style.display="block";
}

// Fingerprint Ã¼ret
async function getFP(){
  const data = navigator.userAgent + screen.width + screen.height + Intl.DateTimeFormat().resolvedOptions().timeZone;
  const hash = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(data));
  return [...new Uint8Array(hash)].map(b=>b.toString(16).padStart(2,"0")).join("");
}

// Konum izni
async function requestGPS(){
  navigator.geolocation.getCurrentPosition(async ()=>{
    izinler.konum = true;
    LS.setItem("gpsOK","1");
    LS.setItem("izinler", JSON.stringify(izinler));
    document.getElementById("fpBox").innerText = "Cihaz KimliÄŸi: " + await getFP();
  }, ()=>{
    warnUI("Konum izni yok â†’ Konum takibi ve otomatik konum paylaÅŸÄ±mÄ± Ã§alÄ±ÅŸmaz.");
  });
}

// Hareket sensÃ¶rÃ¼ izni
async function requestMotion(){
  if(DeviceMotionEvent && typeof DeviceMotionEvent.requestPermission === "function"){
    const r = await DeviceMotionEvent.requestPermission();
    if(r==="granted"){
      izinler.motion = true;
      LS.setItem("motionOK","1");
      LS.setItem("izinler", JSON.stringify(izinler));
      console.log("Motion izni alÄ±ndÄ± âœ”");
    } else {
      warnUI("Hareket sensÃ¶rÃ¼ izni yok â†’ dÃ¼ÅŸme/Ã§arpma analizi kapalÄ± olur.");
    }
  } else {
    warnUI("Hareket sensÃ¶rÃ¼ bu cihaz/tarayÄ±cÄ±da desteklenmiyor.");
  }
}

// Bildirim izni
async function requestNotif(){
  const r = await Notification.requestPermission();
  if(r==="granted"){
    izinler.notif = true;
    LS.setItem("notifOK","1");
    LS.setItem("izinler", JSON.stringify(izinler));
    console.log("Bildirim izni alÄ±ndÄ± âœ”");
  } else {
    warnUI("Bildirim izni yok â†’ Bildirim fonksiyonu kapalÄ± olur.");
  }
}

// Bluetooth izni
async function requestBT(){
  if(!navigator.bluetooth){
    warnUI("Bluetooth yok â†’ AkÄ±llÄ± saat veri alma fonksiyonu Ã§alÄ±ÅŸmaz.");
    return;
  }
  try{
    await navigator.bluetooth.requestDevice({acceptAllDevices:true});
    izinler.bt = true;
    LS.setItem("btOK","1");
    LS.setItem("izinler", JSON.stringify(izinler));
    console.log("Bluetooth izni alÄ±ndÄ± âœ”");
  }catch{
    warnUI("Bluetooth izni verilmedi â†’ saat veri alma kapalÄ± olur.");
  }
}

// Panik 112 onayÄ±
function panicConfirm(){
  document.getElementById("confirmText").innerText = "112 aranabilir. AramayÄ± baÅŸlatmak iÃ§in onay verin.";
  document.getElementById("confirmBox").style.display="block";
}

// 112 yÃ¶nlendirme
function call112(){ location.href="tel:112"; }
function closeConfirm(){ document.getElementById("confirmBox").style.display="none"; }

// GPS + pil izleme (profil kaydedilince baÅŸlat)
function startGPSWatch(){
  if(!izinler.konum) return;
  navigator.geolocation.watchPosition(p=>{
    const {latitude, longitude, speed} = p.coords;
    const kmh = speed ? Math.round(speed * 3.6) : 0;
    const msg = `ğŸ“ ${latitude.toFixed(5)}, ${longitude.toFixed(5)} | ${kmh} km/h`;
    document.getElementById("status").innerText = msg;
  }, ()=> warnUI("Konum kesildi â†’ Konum takibi durdu."), {enableHighAccuracy:true});
}

function startBatteryLoop(){
  navigator.getBattery().then(b=>{
    b.onlevelchange = ()=>{
      const lvl = Math.round(b.level * 100);
      console.log("Pil:", lvl);
      if(lvl <= 5) sendSMS(`ÅarjÄ±m %${lvl} kritik!`, LS.getItem("acilTel"));
      if(lvl <= 1) sendSMS("ÅarjÄ±m %1 hayati kritik!", LS.getItem("acilTel"));
    }
  });
}

// SMS fonksiyonu
function sendSMS(msg,tel){ if(tel) location.href=`sms:${tel}?body=${encodeURIComponent(msg)}`; }

// Profil kaydedilince sistem aktive olur
async function activateSystem(){
  const ad=document.getElementById("ad").value.trim();
  const tel=document.getElementById("tel").value.trim();
  const fp = await getFP();

  if(!ad || !tel) return alert("Ad ve acil kiÅŸi telefonu zorunlu!");

  LS.setItem("profile", JSON.stringify({ad,tel,fp}));
  LS.setItem("acilTel", tel);
  showPanel("mainPanel");
  startGPSWatch();
  startBatteryLoop();
}
</script>

</body>
</html>
