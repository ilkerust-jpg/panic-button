<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>HÄ±zÄ±r Gibi â€” ACÄ°L GÃ¼ven</title>
<style>
body{font-family:sans-serif;padding:20px;margin:0;background:#fff;color:#111}
input{width:100%;padding:12px;font-size:16px;border-radius:8px;border:1px solid #444;margin-top:6px}
button{width:100%;padding:18px;font-size:18px;background:#c00;color:#fff;border:none;border-radius:10px;margin-top:12px;font-weight:600;cursor:pointer}
button.alt{background:#222;color:#fff}
.alert{background:#fffae5;border-left:4px solid #e6a700;padding:12px;border-radius:6px;margin-top:12px;font-size:14px}
.panel{padding:16px;background:#f2f2f2;border-radius:10px;margin-top:14px}
.topbar{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px;background:#111;padding:14px;border-radius:10px}
.topbar button{margin:0;padding:14px;font-size:15px}
#logBox{background:#000;color:#fff;font-size:13px;padding:12px;border-radius:6px;min-height:80px;white-space:pre-wrap;margin-top:10px}
</style>
</head>
<body>

<h2>HÄ±zÄ±r Gibi â€” ACÄ°L GÃ¼ven</h2>

<!-- Ä°zin & Ayar MenÃ¼ -->
<div class="topbar">
  <button class="alt" onclick="openSettings()">âš™ Ayarlar</button>
  <button class="alt" onclick="togglePerms()">ğŸ“Œ Ä°zinler</button>
</div>

<!-- Panik Butonu -->
<button id="panicBtn" onclick="panicConfirm()">ACÄ°L</button>

<!-- Acil KiÅŸiler (profile kayÄ±tlÄ±ysa otomatik aÃ§Ä±lÄ±r) -->
<div id="emergencyContacts"></div>

<!-- CanlÄ± Log (her zaman gÃ¶rÃ¼nÃ¼r) -->
<div class="alert"><strong>CanlÄ± Log</strong><div id="logBox">ğŸ“¡ Sistem bekliyor...</div></div>

<!-- Ayarlar Paneli -->
<div id="settingsPanel" class="panel">
  <h3>âš™ Ayarlar</h3>
  <div class="alert"><strong>Profil</strong><div id="settingsProfile"></div></div>
  <div class="alert"><strong>Ä°zinler</strong><div id="settingsPerms"></div></div>
  <button class="alt" onclick="editProfile()">âœ Profili DÃ¼zenle</button>
  <button class="alt" onclick="closeSettings()">â¬… Ana Ekrana DÃ¶n</button>
</div>

<!-- Ä°zinler Paneli -->
<div id="permPanel" class="panel">
  <h3>Gerekli Ä°zinler</h3>
  <button onclick="requestGPS()">ğŸ“ Konum izni</button>
  <button onclick="requestMotion()" class="alt">ğŸ“± Ä°vme sensÃ¶rÃ¼ izni</button>
  <button onclick="requestNotif()" class="alt">ğŸ”” Bildirim izni</button>
  <button onclick="requestBT()" class="alt">âŒš Bluetooth izni</button>
  <button class="alt" onclick="permissionsDone()">Ä°zinleri Bitir & Profile GeÃ§</button>
  <div id="permAlerts"></div>
</div>

<!-- Profil Paneli -->
<div id="profilePanel" class="panel">
  <h3>Acil Profil</h3>
  <label>KullanÄ±cÄ± (Ad Soyad)</label>
  <input id="ad" placeholder="Ad Soyad"/>
  <label>Acil KiÅŸi 1 (Ä°sim)</label>
  <input id="acil1ad" placeholder="Ã–rn: Ahmet YÄ±lmaz"/>
  <label>Acil KiÅŸi 1 (Telefon)</label>
  <input id="acil1tel" placeholder="05xx xxx xx xx"/>
  <label>Acil KiÅŸi 2 (Ä°sim)</label>
  <input id="acil2ad" placeholder="Opsiyonel"/>
  <label>Acil KiÅŸi 2 (Telefon)</label>
  <input id="acil2tel" placeholder="Opsiyonel"/>
  <button onclick="saveProfile()">Kaydet & BaÅŸlat</button>
</div>

<!-- Panik Onay Paneli -->
<div id="confirmBox" class="panel">
  <h3>ğŸš¨ Acil Onay</h3>
  <p>112â€™yi aramak veya acil kiÅŸileri bilgilendirmek iÃ§in seÃ§im yap:</p>
  <button onclick="call112()">ğŸ“ 112â€™yi Ara</button>
  <button onclick="notifyContacts(1)" id="confirm1btn"></button>
  <button onclick="notifyContacts(2)" id="confirm2btn"></button>
  <button class="alt" onclick="closeConfirm()">Ä°ptal</button>
</div>

<script>
const LS = localStorage;

// UI'a uyarÄ± yaz
function warnUI(m){
  document.getElementById("permAlerts").innerHTML += `<div class="alert">âš  ${m}</div>`;
}

// Ana sayfada izin panelini toggle
function togglePerms(){
  const p=document.getElementById("permPanel");
  p.style.display = p.style.display==="block" ? "none" : "block";
}

// Ayarlar panelini toggle
function openSettings(){
  const p=JSON.parse(LS.getItem("profile")||"{}");
  const perms=JSON.parse(LS.getItem("izinler")||"{}");
  document.getElementById("settingsProfile").innerText = p.ad ? `KullanÄ±cÄ±: ${p.ad}\nAcil 1: ${p.acil1.ad} (${p.acil1.tel})\nAcil 2: ${p.acil2? p.acil2.ad+" ("+p.acil2.tel+")": "â€”"}` : "Profil yok";
  document.getElementById("settingsPerms").innerText = `Konum: ${perms.konum?"AÃ§Ä±k":"KapalÄ±"}\nÄ°vme SensÃ¶rÃ¼: ${perms.motion?"AÃ§Ä±k":"KapalÄ±"}\nBildirim: ${perms.notif?"AÃ§Ä±k":"KapalÄ±"}\nBluetooth: ${perms.bt?"AÃ§Ä±k":"KapalÄ±"}`;
  showPanel("settingsPanel");
}

// Global panel gÃ¶sterme
function showPanel(id){
  ["permPanel","profilePanel","mainPanel","settingsPanel","confirmBox","profilePanel"].forEach(p=>{
    const el=document.getElementById(p);
    if(el) el.style.display="none";
  });
  document.getElementById(id).style.display="block";
}

// Confirm panel
function panicConfirm(){
  const p=JSON.parse(LS.getItem("profile")||"{}");
  document.getElementById("confirm1btn").innerText = `Acil 1: ${p.acil1.ad}`;
  document.getElementById("confirm2btn").innerText = p.acil2 ? `Acil 2: ${p.acil2.ad}` : "";
  showPanel("confirmBox");
}

// 112 arama
function call112(){
  location.href="tel:112";
}

// Acil kiÅŸileri bilgilendir + SMS + WhatsApp paylaÅŸ ekranÄ± aÃ§
async function notifyContacts(n){
  const p=JSON.parse(LS.getItem("profile"));
  const c = n===1 ? p.acil1 : p.acil2;
  if(!c) return warnUI("Acil kiÅŸi yok âŒ");
  const msg=`ğŸš¨ ACÄ°L | ${p.ad} yardÄ±ma ihtiyaÃ§ duyuyor! Konum paylaÅŸÄ±lÄ±yorâ€¦`;
  if(izinler.notif) new Notification("Acil durum tetiklendi!");
  navigator.geolocation?.getCurrentPosition(p=>{
    const loc=`${p.coords.latitude},${p.coords.longitude}`;
    const full=msg+"\nKonum: "+loc;
    location.href=`sms:${c.tel}?body=${encodeURIComponent(full)}`;
    if(navigator.share) navigator.share({title:"Acil Durum",text:full});
    document.getElementById("logBox").innerText += `\nğŸ“¤ Mesaj gÃ¶nderildi: ${c.ad}`;
  });
}

// Profili dÃ¼zenle
function editProfile(){
  const p = JSON.parse(LS.getItem("profile")||"{}");
  document.getElementById("ad").value = p.ad || "";
  document.getElementById("acil1ad").value = p.acil1?.ad || "";
  document.getElementById("acil1tel").value = p.acil1?.tel || "";
  document.getElementById("acil2ad").value = p.acil2?.ad || "";
  document.getElementById("acil2tel").value = p.acil2?.tel || "";
  showPanel("profilePanel");
}

// Ayarlar kapat
function closeSettings(){ showPanel("mainPanel"); }

// Confirm kapat
function closeConfirm(){ document.getElementById("confirmBox").style.display="none"; showPanel("mainPanel"); }

// Profil kaydet
async function saveProfile(){
  const ad=document.getElementById("ad").value.trim();
  const a1=document.getElementById("acil1ad").value.trim();
  const t1=document.getElementById("acil1tel").value.trim();
  const a2=document.getElementById("acil2ad").value.trim();
  const t2=document.getElementById("acil2tel").value.trim();
  if(!ad||!a1||!t1) return alert("Eksik alan âŒ");
  const fp=await getFP();
  const obj={ad,fp,acil1:{ad:a1,tel:t1},acil2:a2&&t2?{ad:a2,tel:t2}:null};
  LS.setItem("profile", JSON.stringify(obj));
  LS.setItem("izinler", JSON.stringify(izinler));
  startLoops();
  showPanel("mainPanel");
}

// Loops
function startLoops(){
  navigator.getBattery().then(b=>{
    setInterval(()=>{
      const lvl=Math.round(b.level*100);
      document.getElementById("logBox").innerText = "ğŸ”‹ Pil: %" + lvl;
    },30000);
  });
  navigator.geolocation?.watchPosition(p=>{
    document.getElementById("logBox").innerText += `\nğŸ“ Konum: ${p.coords.latitude},${p.coords.longitude}`;
  });
}

// AÃ§Ä±lÄ±ÅŸ
window.onload = ()=>{
  if(LS.getItem("profile")){
    const p=JSON.parse(LS.getItem("profile"));
    document.getElementById("emergencyContacts").innerHTML =
      `<button onclick="triggerEmergency(1)">Acil 1: ${p.acil1.ad} â€” Ara & Konum + Mesaj GÃ¶nder</button>` +
      (p.acil2?`<button onclick="triggerEmergency(2)">Acil 2: ${p.acil2.ad} â€” Ara & Konum + Mesaj GÃ¶nder</button>`:"");
    showPanel("mainPanel");
    startLoops();
  } else showPanel("permPanel");
}
</script>

</body>
</html>
