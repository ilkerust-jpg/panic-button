<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>HG ACÄ°L</title>
<style>
  body{font-family:sans-serif;padding:20px;margin:0;background:#fff;color:#111}
  input{width:100%;padding:12px;font-size:16px;border-radius:8px;border:1px solid #444;margin-top:6px}
  button{width:100%;padding:18px;font-size:18px;background:#c00;color:#fff;border:none;border-radius:10px;margin-top:12px;font-weight:600}
  button.alt{background:#222}
  .alert{background:#fff3cd;border-left:4px solid #ffb300;padding:12px;border-radius:6px;margin-top:12px;font-size:14px}
  .topbar{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px;background:#111;padding:14px;border-radius:10px}
  .topbar button{margin:0;padding:14px;font-size:15px}
  #panicBtn{font-size:22px;padding:26px;border-radius:12px;width:100%;font-weight:700;background:#c00}
  #settingsPanel, #permPanel, #profilePanel, #mainPanel{display:none}
  #confirmBox{display:none;position:fixed;top:30%;left:5%;width:90%;background:#fff;padding:16px;border-radius:12px;box-shadow:0 0 16px rgba(0,0,0,0.3)}
</style>
</head>
<body>

<div class="topbar">
  <button class="alt" onclick="openSettings()">âš™ Ayarlar</button>
  <button class="alt" onclick="showPanel('permPanel')">ğŸ“Œ Ä°zinler</button>
</div>

<!-- Ä°zinler Paneli -->
<div id="permPanel" class="panel">
  <h3>Gerekli Ä°zinler</h3>
  <button onclick="requestGPS()">ğŸ“ Konum izni</button>
  <button onclick="requestMotion()">ğŸ“± Ä°vme sensÃ¶rÃ¼ izni</button>
  <button onclick="requestNotif()">ğŸ”” Bildirim izni</button>
  <button onclick="requestBT()" class="alt">âŒš Bluetooth izni</button>
  <div id="sensorResult" style="margin-top:10px;font-size:14px"></div>
  <button onclick="permissionsDone()" class="alt">Ä°zinleri Bitir & Profile GeÃ§</button>
</div>

<!-- Profil Paneli -->
<div id="profilePanel" class="panel">
  <h3>Acil Profil</h3>
  <div id="deviceBox" style="font-size:13px;color:#333;margin-bottom:8px"></div>

  <label>KullanÄ±cÄ± (Ad Soyad)</label>
  <input id="ad" placeholder="Ad Soyad"/>

  <label>Acil KiÅŸi 1 (Ä°sim)</label>
  <input id="acil1ad" placeholder="Ã–rn: Ahmet YÄ±lmaz"/>

  <label>Acil KiÅŸi 1 (Telefon)</label>
  <input id="acil1tel" placeholder="05xx xxx xx xx"/>

  <label>Acil KiÅŸi 2 (Ä°sim)</label>
  <input id="acil2ad" placeholder="Opsiyonel"/>

  <label>Acil KiÅŸi 2 (Telefon)</label>
  <input id="acil2tel" placeholder="Opsiyonel"/>

  <button onclick="saveProfile()">Kaydet & BaÅŸlat</button>
</div>

<!-- Ana Sistem Paneli -->
<div id="mainPanel" class="panel">
  <h3>Sistem Aktif</h3>
  <div id="status" class="alert">ğŸ“¡ Sistem BaÅŸlÄ±yorâ€¦</div>

  <button onclick="callEmergency(1)" id="acil1btn"></button>
  <button onclick="callEmergency(2)" id="acil2btn"></button>

  <button id="panicBtn" onclick="panicConfirm()">ACÄ°L</button>
</div>

<!-- Ayarlar Paneli -->
<div id="settingsPanel" class="panel alt">
  <h3>âš™ Ayarlar</h3>
  <pre id="settingsPerms" style="font-size:12px;color:#0f0;background:#000;padding:10px;border-radius:6px"></pre>
  <pre id="settingsProfile" style="font-size:12px;color:#0ff;background:#000;padding:10px;border-radius:6px;margin-top:10px"></pre>

  <button onclick="editProfile()" class="alt">Profili DÃ¼zenle</button>
  <button onclick="closeSettings()" class="alt">Ana ekrana dÃ¶n</button>
</div>

<!-- Panik Onay Paneli -->
<div id="confirmBox">
  <div id="confirmText"></div>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px">
    <button onclick="call112()">ğŸ“ 112</button>
    <button onclick="callEmergency(1)" id="confirm1btn"></button>
    <button onclick="callEmergency(2)" id="confirm2btn"></button>
    <button onclick="closeConfirm()" class="alt">Ä°ptal</button>
  </div>
</div>

<script>
const LS = localStorage;

// Fingerprint Ã¼retici
async function getFP(){
  const raw = navigator.userAgent + screen.width + screen.height + Intl.DateTimeFormat().resolvedOptions().timeZone;
  const buf = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(raw));
  return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,"0")).join("");
}

// Panel gÃ¶ster/gizle motoru
function showPanel(id){
  ["permPanel","profilePanel","mainPanel","settingsPanel","confirmBox"].forEach(p=>{
    const el=document.getElementById(p);
    if(el) el.style.display="none";
  });
  const t=document.getElementById(id);
  if(t) t.style.display="block";
}

// UyarÄ± UIâ€™a yaz
function warn(msg){
  const box=document.getElementById("alerts");
  box.innerHTML += `<div class="alert">âš  ${msg}</div>`;
}

// Ä°zinleri sakla ve UIâ€™a yaz
let izinler = JSON.parse(LS.getItem("izinler") || '{"konum":false,"motion":false,"notif":false,"bt":false}');
LS.setItem("izinler", JSON.stringify(izinler));

function permissionsDone(){ showPanel("profilePanel"); }

// Konum izni al
function requestGPS(){
  if(!navigator.geolocation){ warn("Konum API yok âŒ"); return; }
  navigator.geolocation.getCurrentPosition(()=>{
    izinler.konum=true;
    LS.setItem("izinler", JSON.stringify(izinler));
    document.getElementById("sensorResult").innerText="ğŸ“ Konum izni alÄ±ndÄ± âœ”";
  }, ()=> warn("Konum izni reddedildi âŒ"));
}

// Ä°vme sensÃ¶rÃ¼ izni al
async function requestMotion(){
  if(!window.DeviceMotionEvent){
    document.getElementById("sensorResult").innerText="Ä°vme sensÃ¶rÃ¼ desteklenmiyor â— Manuel ACÄ°L Ã§alÄ±ÅŸÄ±r";
    return;
  }
  if(typeof DeviceMotionEvent.requestPermission === "function"){
    const r = await DeviceMotionEvent.requestPermission();
    if(r==="granted"){
      izinler.motion=true;
      LS.setItem("izinler", JSON.stringify(izinler));
      document.getElementById("sensorResult").innerText="ğŸ“± Ä°vme sensÃ¶rÃ¼ izni alÄ±ndÄ± âœ”";
    } else warn("Ä°vme sensÃ¶rÃ¼ izni reddedildi âŒ");
  } else {
    document.getElementById("sensorResult").innerText="ğŸ“± Ä°vme sensÃ¶rÃ¼ eriÅŸilebilir âœ”";
    izinler.motion=true;
    LS.setItem("izinler", JSON.stringify(izinler));
  }
}

// Bildirim izni al
async function requestNotif(){
  if(!window.Notification){ warn("Bildirim API yok âŒ"); return; }
  const r = await Notification.requestPermission();
  if(r==="granted"){
    izinler.notif=true;
    LS.setItem("izinler", JSON.stringify(izinler));
    document.getElementById("sensorResult").innerText="ğŸ”” Bildirim izni alÄ±ndÄ± âœ”";
  } else warn("Bildirim izni reddedildi âŒ");
}

// Bluetooth izni al
async function requestBT(){
  if(!navigator.bluetooth){ warn("Bluetooth API yok âŒ"); return; }
  try{
    await navigator.bluetooth.requestDevice({acceptAllDevices:true});
    izinler.bt=true;
    LS.setItem("izinler", JSON.stringify(izinler));
    document.getElementById("sensorResult").innerText="âŒš Bluetooth izni alÄ±ndÄ± âœ”";
  } catch { warn("Bluetooth izni reddedildi âŒ"); }
}

// Profil kaydet ve butonlarÄ± baÄŸla
async function saveProfile(){
  const userAd=document.getElementById("ad").value.trim();
  const acil1Ad=document.getElementById("acil1ad").value.trim();
  const acil1Tel=document.getElementById("acil1tel").value.trim();
  const acil2Ad=document.getElementById("acil2ad").value.trim();
  const acil2Tel=document.getElementById("acil2tel").value.trim();
  const fp = await getFP();

  if(!userAd || !acil1Ad || !acil1Tel){
    return alert("Zorunlu alanlar eksik âŒ");
  }

  const pObj={ad:userAd,fp,acil1:{ad:acil1Ad,tel:acil1Tel},acil2: acil2Ad&&acil2Tel?{ad:acil2Ad,tel:acil2Tel}:null};
  LS.setItem("profile", JSON.stringify(pObj));
  bindMainButtons();
}

// Ana panelde butonlarÄ± baÄŸla
function bindMainButtons(){
  bindMainButtons();
}

function bindMainButtons(){
  bindMainButtons();
}

function bindMainButtons(){
  bindMainButtons();
}

function bindMainButtons(){
  bindMainButtons();
}

function bindMainButtons(){
  const p=JSON.parse(LS.getItem("profile"));
  document.getElementById("acil1btn").style.display="block";
  document.getElementById("acil1btn").innerText=`Acil 1: ${p.acil1.ad} â€” Ara & Konum + Mesaj GÃ¶nder`;
  if(p.acil2){
    document.getElementById("acil2btn").style.display="block";
    document.getElementById("acil2btn").innerText=`Acil 2: ${p.acil2.ad} â€” Ara & Konum + Mesaj GÃ¶nder`;
  } else {
    document.getElementById("acil2btn").style.display="none";
  }
  showPanel("mainPanel");
}

// 112 ve acil kiÅŸileri arama
function callEmergency(n){
  const p=JSON.parse(LS.getItem("profile"));
  const tel = n===1 ? p.acil1.tel : p.acil2?.tel;
  if(!tel) return alert("Acil kiÅŸi yok âŒ");
  location.href="tel:"+tel;
  sendShare(tel, p.ad);
}

function call112(){ location.href="tel:112"; }
function closeConfirm(){ document.getElementById("confirmBox").style.display="none"; }

// Konum + SMS/PaylaÅŸÄ±m
function sendShare(tel, user){
  navigator.geolocation.getCurrentPosition(p=>{
    const msg=`ğŸš¨ Acil Durum | ${user} | Konum: ${p.coords.latitude},${p.coords.longitude}`;
    location.href=`sms:${tel}?body=${encodeURIComponent(msg)}`;
  });
}

window.onload = ()=>{
  const p = LS.getItem("profile");
  if(p){ bindMainButtons(); } else { showPanel("permPanel"); }
}
</script>

</body>
</html>
