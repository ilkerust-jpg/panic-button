<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>HG ACÄ°L</title>
<style>
body{font-family:sans-serif;padding:18px;margin:0;background:#fff;color:#111}
button{width:100%;padding:22px;font-size:21px;background:#d33;color:#fff;border:none;border-radius:12px;margin-top:14px;font-weight:600;cursor:pointer}
button.alt{background:#222;font-size:16px;padding:14px}
#logBox{background:#000;color:#0f0;font-size:13px;padding:12px;border-radius:8px;margin-top:14px;min-height:50px;text-align:left}
.panel{background:#f5f5f5;padding:14px;border-radius:10px;margin-top:14px;font-size:14px;text-align:left}
#permPanel,#settingsPanel{display:none}
</style>
</head>
<body>

<div id="alerts"></div>

<!-- Ana ACÄ°L butonu -->
<button onclick="panic()">ACÄ°L</button>

<!-- Acil kiÅŸi butonlarÄ± -->
<div id="emergencyContacts"></div>

<!-- CanlÄ± log alanÄ± (kÄ±sa ve okunur, auto refresh) -->
<div id="logBox">HazÄ±rlanÄ±yorâ€¦</div>

<!-- Ä°zinler Paneli -->
<div id="permPanel" class="panel">
  <h3>Gerekli Ä°zinler</h3>
  <button onclick="requestGPS()">ğŸ“ Konum izni</button>
  <button onclick="requestMotion()" class="alt">ğŸ“± Hareket/Ä°vme izni</button>
  <button onclick="requestNotif()" class="alt">ğŸ”” Bildirim izni</button>
  <button onclick="requestBT()" class="alt">âŒš Bluetooth izni</button>
  <div id="permResult" style="margin-top:10px"></div>
  <button onclick="togglePerms()" class="alt">Kapat</button>
</div>

<!-- Ayarlar Paneli -->
<div id="settingsPanel" class="panel">
  <h3>âš™ Ayarlar</h3>
  <p id="settingsProfile"></p>
  <p id="settingsPerms"></p>
  <button onclick="toggleSettings()" class="alt">Kapat</button>
</div>

<script>
const LS = localStorage;

// Log yazÄ±cÄ± (max 2 satÄ±r, auto refresh)
let logLines=[];
function updateLogUI(m){
  if(logLines.length>=2) logLines.shift();
  logLines.push(m);
  document.getElementById("logBox").innerText = logLines.join("\n");
  console.log(m);
}

// Profili yÃ¼kle
function loadProfile(){
  const p=JSON.parse(LS.getItem("profile")||"null");
  if(!p) return false;
  let html=`<button class="contactBtn" onclick="callEmergency(1)">Acil 1: ${p.acil1.ad}</button>`;
  if(p.acil2) html+=`<button class="contactBtn" onclick="callEmergency(2)">Acil 2: ${p.acil2.ad}</button>`;
  document.getElementById("emergencyContacts").innerHTML=html;
  return true;
}

// Ä°zinler storage
let izinler = JSON.parse(LS.getItem("izinler")||`{"gps":false,"motion":false,"notif":false,"bt":false}`);
LS.setItem("izinler",JSON.stringify(izinler));

// Ä°zin fonksiyonlarÄ±
function requestGPS(){
  if(!navigator.geolocation) return warn("Konum API yok âŒ");
  navigator.geolocation.getCurrentPosition(p=>{
    izinler.gps=true;
    LS.setItem("izinler",JSON.stringify(izinler));
    document.getElementById("permResult").innerText="ğŸ“ Konum izni alÄ±ndÄ± âœ”";
    updateLogUI("Konum: "+p.coords.latitude+","+p.coords.longitude);
  },()=>warn("Konum izni yok âŒ"));
}

function requestMotion(){
  if(!window.DeviceMotionEvent){
    document.getElementById("permResult").innerText="Ä°vme sensÃ¶rÃ¼ desteklenmiyor â—";
    return;
  }
  izinler.motion=true;
  LS.setItem("izinler",JSON.stringify(izinler));
  document.getElementById("permResult").innerText="ğŸ“± Ä°vme/Hareket izni alÄ±ndÄ± âœ”";
  updateLogUI("ğŸ“± Motion sensÃ¶r eriÅŸimi âœ”");
}

async function requestNotif(){
  if(!window.Notification) return warn("Bildirim API yok âŒ");
  const r=await Notification.requestPermission();
  if(r==="granted"){
    izinler.notif=true;
    LS.setItem("izinler",JSON.stringify(izinler));
    document.getElementById("permResult").innerText="ğŸ”” Bildirim izni alÄ±ndÄ± âœ”";
  } else warn("Bildirim izni yok âŒ");
}

async function requestBT(){
  if(!navigator.bluetooth) return warn("Bluetooth API yok âŒ");
  try{
    await navigator.bluetooth.requestDevice({acceptAllDevices:true});
    izinler.bt=true;
    LS.setItem("izinler",JSON.stringify(izinler));
    document.getElementById("permResult").innerText="âŒš Bluetooth izni alÄ±ndÄ± âœ”";
  } catch{ warn("Bluetooth izni yok âŒ"); }
}

// Acil akÄ±ÅŸ
function callEmergency(n){
  const p=JSON.parse(LS.getItem("profile"));
  const c = n===1 ? p.acil1 : p.acil2;
  if(!c?.tel) return warn("Acil kiÅŸi tel yok âŒ");
  updateLogUI("ğŸ“ "+c.ad+" aranÄ±yorâ€¦");
  location.href="tel:"+c.tel;

  // Senin periyotlarda SMS/Share tetiklenecek
  const now=new Date();
  const hour=now.getHours();
  if(p.ad){
    const msg=`ğŸš¨ Acil | ${p.ad} yardÄ±ma ihtiyaÃ§ duyuyor!`;
    navigator.share?.({title:"Acil",text:msg});
    updateLogUI("ğŸ“¤ PaylaÅŸ paneli hazÄ±r âœ” (WhatsApp seÃ§ilebilir)");
  }
}

// Toggle paneller
function togglePerms(){
  const p=document.getElementById("permPanel");
  p.style.display=p.style.display==="block"?"none":"block";
}
function toggleSettings(){
  const p=document.getElementById("settingsPanel");
  p.style.display=p.style.display==="block"?"none":"block";
}
function openSettings(){
  const p=JSON.parse(LS.getItem("profile")||"{}");
  const perms=JSON.parse(LS.getItem("izinler")||"{}");
  document.getElementById("settingsProfile").innerText = p.ad ? `KullanÄ±cÄ±: ${p.ad}\nAcil 1: ${p.acil1?.ad} (${p.acil1?.tel})\nAcil 2: ${p.acil2?.ad||"â€”"}` : "Profil yok";
  document.getElementById("settingsPerms").innerText = `Konum: ${perms.gps?"AÃ§Ä±k":"KapalÄ±"} | Motion: ${perms.motion?"AÃ§Ä±k":"KapalÄ±"} | Bildirim: ${perms.notif?"AÃ§Ä±k":"KapalÄ±"} | BT: ${perms.bt?"AÃ§Ä±k":"KapalÄ±"}`;
  document.getElementById("settingsPanel").style.display="block";
}
function editProfile(){
  showPanel("profilePanel");
}

// AÃ§Ä±lÄ±ÅŸta
window.onload = ()=>{
  if(!loadProfile()){
    warn("Profil kayÄ±tlÄ± deÄŸil â— ACÄ°L manuel Ã§alÄ±ÅŸÄ±r.");
    togglePerms();
  }
  updateLogUI("Sistem hazÄ±r âœ”");
}
</script>

</body>
</html>
