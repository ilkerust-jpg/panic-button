<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>HG ACÄ°L</title>
<style>
body{font-family:sans-serif;padding:16px;margin:0;background:#fff;color:#111;text-align:center}
#panicBtn{width:90%;padding:24px;font-size:22px;background:#d00;color:#fff;border:none;border-radius:12px;font-weight:700;margin-top:12px;cursor:pointer}
.contactBtn{width:90%;padding:16px;font-size:17px;background:#222;color:#fff;border:none;border-radius:10px;margin-top:10px;cursor:pointer;font-weight:600}
#log{background:#111;color:#fff;font-size:14px;padding:12px;border-radius:8px;margin-top:18px;min-height:90px;white-space:pre-wrap;text-align:left}
.warn{background:#ffefc2;color:#b00;padding:10px;border-left:3px solid #e6a700;border-radius:6px;margin-top:14px;font-size:13px;text-align:left;width:90%;margin-left:auto;margin-right:auto}
</style>
</head>
<body>

<h2>Acil Durum Ä°zleme</h2>
<button id="panicBtn" onclick="panic()">ACÄ°L</button>

<div id="contacts"></div>

<h3>CanlÄ± Log</h3>
<div id="log">Sistem bekliyorâ€¦</div>

<div id="warnings"></div>

<script>
const LS = localStorage;

// Profili storageâ€™dan yÃ¼kle ve acil kiÅŸileri butonlara baÄŸla
function loadProfile(){
  const p = JSON.parse(LS.getItem("profile")||"null");
  if(!p) return false;

  let html = `<button class="contactBtn" onclick="acil(1)">Acil 1: ${p.acil1.ad}</button>`;
  if(p.acil2) html += `<button class="contactBtn" onclick="acil(2)">Acil 2: ${p.acil2.ad}</button>`;
  document.getElementById("contacts").innerHTML = html;

  return true;
}

// UyarÄ± kutusuna mesaj yaz
function warn(m){
  document.getElementById("warnings").innerHTML += `<div class="warn">${m}</div>`;
}

// Log ekranÄ±na veri yaz
function log(m){
  document.getElementById("log").innerText += "\n" + m;
  console.log(m);
}

// Ä°zinleri bir kez al
let izin = JSON.parse(LS.getItem("izin")||`{"gps":false,"motion":false,"notif":false,"bt":false,"sms":false}`);
LS.setItem("izin", JSON.stringify(izin));

// Konum izni
async function requestGPS(){
  if(!navigator.geolocation) return warn("Konum API yok âŒ");
  navigator.geolocation.getCurrentPosition(()=>{
    izin.gps=true;
    LS.setItem("izin",JSON.stringify(izin));
    log("ğŸ“ Konum izni alÄ±ndÄ± âœ”");
  },()=>warn("Konum izni verilmedi âŒ Konum paylaÅŸÄ±mÄ± kapalÄ± olur."));
}

// Ä°vme sensÃ¶rÃ¼ izni
async function requestMotion(){
  if(!window.DeviceMotionEvent) return warn("Ä°vme sensÃ¶rÃ¼ desteklenmiyor â—");
  if(typeof DeviceMotionEvent.requestPermission==="function"){
    const r=await DeviceMotionEvent.requestPermission();
    if(r==="granted"){
      izin.motion=true;
      LS.setItem("izin",JSON.stringify(izin));
      log("ğŸ“± Ä°vme sensÃ¶rÃ¼ izni alÄ±ndÄ± âœ”");
    } else warn("Ä°vme sensÃ¶rÃ¼ izni reddedildi âŒ");
  } else {
    izin.motion=true;
    LS.setItem("izin",JSON.stringify(izin));
    log("ğŸ“± Ä°vme sensÃ¶rÃ¼ eriÅŸilebilir âœ”");
  }
}

// Bildirim izni
async function requestNotif(){
  if(!window.Notification) return warn("Bildirim API yok âŒ");
  const r=await Notification.requestPermission();
  if(r==="granted"){
    izin.notif=true;
    LS.setItem("izin",JSON.stringify(izin));
    log("ğŸ”” Bildirim izni alÄ±ndÄ± âœ”");
  } else warn("Bildirim izni yok âŒ Bildirim fonksiyonu kapalÄ± olur.");
}

// SMS izni (manuel izin yoksa bir kez sorar)
async function requestSMS(){
  const r=confirm("SMS gÃ¶nderme izni verilsin mi? (Bir kez sorulacak)");
  if(r){
    izin.sms=true;
    LS.setItem("izin",JSON.stringify(izin));
    log("âœ‰ SMS izni verildi âœ”");
  } else warn("SMS izni yok âŒ SMS taslaÄŸÄ± aÃ§Ä±lÄ±r ama otomatik dolmaz.");
}

// Batarya ve konum, ivme ve hÄ±z loglarÄ±
function startSensors(){
  navigator.getBattery?.().then(b=>{
    setInterval(()=>log("ğŸ”‹ Pil: %"+Math.round(b.level*100)),30000);
  });
  navigator.geolocation?.watchPosition(p=>log("ğŸ“ Konum:"+p.coords.latitude+","+p.coords.longitude));
  window.addEventListener("devicemotion",e=>{
    if(!izin.motion) return;
    log("ğŸ“± Ä°vme X:"+e.acceleration.x?.toFixed(2));
  });
  setInterval(()=>{
    const spd = (Math.random()*1.5+20).toFixed(2);
    log("ğŸš— HÄ±z simÃ¼lasyon:"+spd+" m/s");
  },5000);
}

// ACÄ°L tetik akÄ±ÅŸÄ±
async function acil(n){
  const p = JSON.parse(LS.getItem("profile"));
  const c = n===1 ? p.acil1 : p.acil2;
  if(!c?.tel) return warn("Acil kiÅŸi yok âŒ");

  const shareMsg = `ğŸš¨ ACÄ°L | ${p.ad} yardÄ±ma ihtiyaÃ§ duyuyor!\nKonum alÄ±nÄ±yor...`;
  log("ğŸ“ "+c.ad+" aranÄ±yor âœ”");

  // AramayÄ± aÃ§
  location.href="tel:"+c.tel;

  // SMS gÃ¶nder
  if(!izin.sms) await requestSMS();
  navigator.geolocation.getCurrentPosition(pos=>{
    const loc=pos.coords.latitude+","+pos.coords.longitude;
    const fullMsg = `ğŸš¨ ACÄ°L | ${p.ad}\nKonum: ${loc}`;
    if(izin.sms) location.href=`sms:${c.tel}?body=`+encodeURIComponent(fullMsg);
    if(navigator.share) navigator.share({title:"Acil",text:fullMsg});
    log("ğŸ“¤ PaylaÅŸÄ±m paneli aÃ§Ä±ldÄ± âœ” (WhatsApp seÃ§ilebilir)");
  });
}

// ACÄ°L butonu
async function panic(){
  const hasProfile = loadProfile();
  if(!hasProfile){
    warn("Profil yok âŒ Ã–nce izinleri ve profili doldurmalÄ±sÄ±n.");
    showPermUI();
    return;
  }
  showConfirmUI();
}

// Confirm panel
function showConfirmUI(){
  const el=document.getElementById("confirmPanel");
  el.style.display="block";
}

// Perm UI ilk kullanÄ±m
function showPermUI(){
  document.getElementById("warnings").innerHTML += `
  <div class="warn">âš  Ä°zinler eksik olabilir, izinler panelinden aktif edebilirsin.</div>`;
}

// Permission butonlarÄ±nÄ± ana sayfaya ekle
function showPermUI(){
  document.getElementById("warnings").innerHTML += `
  <div class="warn">âš  Ä°zinler eksik olabilir, izinler panelinden aktif edebilirsin.</div>`;
}

window.onload = ()=>{
  const ok = loadProfile();
  if(!ok) warn("HenÃ¼z profil kayÄ±tlÄ± deÄŸil, ACÄ°L butonu manuel Ã§alÄ±ÅŸÄ±r ama kiÅŸileri baÄŸlaman gerekir.");
  startSensors();
}
</script>

</body>
</html>
