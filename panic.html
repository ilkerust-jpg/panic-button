<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>HÄ±zÄ±r Gibi â€” ACÄ°L GÃ¼ven</title>
<style>
body{font-family:sans-serif;padding:20px;margin:0;background:#fff;color:#111}
input{width:100%;padding:12px;font-size:16px;border-radius:8px;border:1px solid #444;margin-top:6px}
button{width:100%;padding:18px;font-size:18px;background:#c00;color:#fff;border:none;border-radius:10px;margin-top:12px;font-weight:600;cursor:pointer}
button.alt{background:#222}
.alert{background:#fff3cd;border-left:4px solid #ffb300;padding:12px;border-radius:6px;margin-top:12px;font-size:14px}
.panel{padding:16px;background:#f2f2f2;border-radius:10px;margin-bottom:14px}
.topbar{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px;background:#111;padding:14px;border-radius:10px}
.topbar button{margin:0;padding:14px;font-size:15px}
#panicBtn{background:#c00;font-size:22px;padding:26px;border-radius:12px;width:100%;font-weight:700}
#settingsPanel,#permPanel,#profilePanel,#mainPanel,#confirmBox{display:none}
#logBox{background:#000;color:#0f0;font-size:12px;padding:10px;border-radius:6px;min-height:60px;white-space:pre-wrap}
</style>
</head>
<body>

<h2>HÄ±zÄ±r Gibi â€” ACÄ°L GÃ¼ven</h2>

<div class="topbar">
  <button class="alt" onclick="openSettings()">âš™ Ayarlar</button>
  <button class="alt" onclick="showPanel('permPanel')">ğŸ“Œ Ä°zinler</button>
</div>

<!-- LOG PANEL (arka planda dÃ¶nen veri UIâ€™a yazÄ±lÄ±r, kaybolmaz) -->
<div class="alert"><strong>CanlÄ± Log</strong><div id="logBox"></div></div>

<!-- Ä°zinler Paneli -->
<div id="permPanel" class="panel">
  <h3>Gerekli Ä°zinler</h3>
  <button onclick="requestGPS()">ğŸ“ Konum izni</button>
  <button onclick="requestMotion()" class="alt">ğŸ“± Ä°vme sensÃ¶rÃ¼ izni</button>
  <button onclick="requestNotif()" class="alt">ğŸ”” Bildirim izni</button>
  <button onclick="requestBT()" class="alt">âŒš Bluetooth izni</button>
  <div id="sensorResult"></div>
  <button onclick="permissionsDone()" class="alt">Ä°zinleri Bitir & Profile GeÃ§</button>
</div>

<!-- Profil Paneli -->
<div id="profilePanel" class="panel">
  <h3>Acil Profil</h3>
  <label>KullanÄ±cÄ± (Ad Soyad)</label>
  <input id="ad" placeholder="Ad Soyad"/>

  <label>Acil 1 (Ä°sim)</label>
  <input id="acil1ad" placeholder="Ã–rn: Ahmet YÄ±lmaz"/>

  <label>Acil 1 (Telefon)</label>
  <input id="acil1tel" placeholder="05xx xxx xx xx"/>

  <label>Acil 2 (Ä°sim)</label>
  <input id="acil2ad" placeholder="Opsiyonel"/>

  <label>Acil 2 (Telefon)</label>
  <input id="acil2tel" placeholder="Opsiyonel"/>

  <button onclick="saveProfile()">Kaydet & BaÅŸlat</button>
</div>

<!-- Ana Sistem Paneli -->
<div id="mainPanel" class="panel">
  <h3>Sistem Aktif</h3>
  <div id="status" class="alert">ğŸ“¡ Ä°zleme aktifâ€¦</div>

  <button onclick="triggerEmergency(1)" id="acil1btn" style="display:none"></button>
  <button onclick="triggerEmergency(2)" id="acil2btn" style="display:none"></button>

  <button id="panicBtn" onclick="panicConfirm()">ACÄ°L</button>
</div>

<!-- Ayarlar Paneli -->
<div id="settingsPanel" class="panel">
  <h3>âš™ Ayarlar</h3>
  <div class="alert"><strong>Profil</strong><pre id="settingsProfile"></pre></div>
  <div class="alert"><strong>Ä°zinler</strong><pre id="settingsPerms"></pre></div>
  <button class="alt" onclick="editProfile()">âœ Profili DÃ¼zenle</button>
  <button class="alt" onclick="showPanel('mainPanel')">â¬… Ana Ekrana DÃ¶n</button>
</div>

<script>
const LS = localStorage;

// LoglarÄ± ekrana yaz
function writeLog(m){
  const box=document.getElementById("logBox");
  box.innerText += m + "\n";
  console.log(m);
}

// Ä°zin ve profil storage baÅŸlat
let izinler = JSON.parse(LS.getItem("izinler") || '{"konum":false,"motion":false,"notif":false,"bt":false}');
LS.setItem("izinler", JSON.stringify(izinler));

// Fingerprint Ã¼retici
async function getFP(){
  const raw = navigator.userAgent + screen.width + screen.height + Intl.DateTimeFormat().resolvedOptions().timeZone;
  const buf = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(raw));
  return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,"0")).join("");
}

// Panel motoru
function showPanel(id){
  ["permPanel","profilePanel","mainPanel","settingsPanel","confirmBox"].forEach(p=>{
    const el=document.getElementById(p);
    if(el) el.style.display="none";
  });
  document.getElementById(id).style.display="block";
}

function permissionsDone(){ showPanel("profilePanel"); }

function requestGPS(){
  navigator.geolocation.getCurrentPosition(p=>{
    izinler.konum=true;
    LS.setItem("izinler", JSON.stringify(izinler));
    writeLog("ğŸ“ Konum izni verildi âœ” Lat:" + p.coords.latitude);
  }, ()=> warn("Konum izni yok âŒ Konum paylaÅŸÄ±mÄ± Ã§alÄ±ÅŸmaz."));
}

function requestMotion(){
  if(!window.DeviceMotionEvent){
    writeLog("Ä°vme sensÃ¶rÃ¼ yok â— Manuel ACÄ°L Ã§alÄ±ÅŸÄ±r");
  } else {
    izinler.motion=true;
    LS.setItem("izinler", JSON.stringify(izinler));
    writeLog("ğŸ“± Ä°vme sensÃ¶rÃ¼ izni verildi âœ”");
  }
}

async function requestNotif(){
  if(!window.Notification){ return warn("Bildirim API yok âŒ"); }
  const r = await Notification.requestPermission();
  if(r==="granted"){
    izinler.notif=true;
    LS.setItem("izinler", JSON.stringify(izinler));
    writeLog("ğŸ”” Bildirim izni verildi âœ”");
  } else warn("Bildirim izni yok âŒ Bildirim fonksiyonu kapalÄ± olur.");
}

async function requestBT(){
  if(!navigator.bluetooth){ warn("Bluetooth yok âŒ"); return; }
  try{
    await navigator.bluetooth.requestDevice({acceptAllDevices:true});
    izinler.bt=true;
    LS.setItem("izinler", JSON.stringify(izinler));
    writeLog("âŒš Bluetooth izni verildi âœ”");
  } catch { warn("Bluetooth izni yok âŒ"); }
}

// Profil kaydet ve butonlarÄ± baÄŸla
async function saveProfile(){
  const ad=document.getElementById("ad").value.trim();
  const a1=document.getElementById("acil1ad").value.trim();
  const t1=document.getElementById("acil1tel").value.trim();
  const a2=document.getElementById("acil2ad").value.trim();
  const t2=document.getElementById("acil2tel").value.trim();
  const fp = await getFP();

  if(!ad||!a1||!t1) return alert("Zorunlu alan eksik âŒ");

  const pObj={ad,fp,acil1:{ad:a1,tel:t1},acil2:a2&&t2?{ad:a2,tel:t2}:null};
  LS.setItem("profile", JSON.stringify(pObj));
  bindMainButtons();
  startLoops();
  alert("Sistem baÅŸlatÄ±ldÄ± âœ” ArtÄ±k tekrar bilgi sormayacak.");
}

function bindMainButtons(){
  const p=JSON.parse(LS.getItem("profile"));
  const b1=document.getElementById("acil1btn");
  const b2=document.getElementById("acil2btn");
  b1.style.display="block";
  b1.innerText=`Acil 1: ${p.acil1.ad} â€” Ara & Konum + Mesaj GÃ¶nder`;
  if(p.acil2){ b2.style.display="block"; b2.innerText=`Acil 2: ${p.acil2.ad} â€” Ara & Konum + Mesaj GÃ¶nder`; }
  else{ b2.style.display="none"; }
  showPanel("mainPanel");
}

// Panik veya sensÃ¶r uyarÄ±nca acil akÄ±ÅŸ
async function triggerEmergency(n){
  const p=JSON.parse(LS.getItem("profile"));
  const tel = n===1 ? p.acil1.tel : p.acil2?.tel;
  if(!tel) return alert("Acil kiÅŸi yok âŒ");
  location.href="tel:"+tel;

  // SMS gÃ¶nder
  const msg=`ğŸš¨ Acil Durum | ${p.ad} | Konum paylaÅŸÄ±lÄ±yorâ€¦`;
  location.href=`sms:${tel}?body=${encodeURIComponent(msg)}`;

  // WhatsApp paylaÅŸ ekranÄ± aÃ§ (browser fallback)
  if(navigator.share){
    try{
      await navigator.share({title:"Acil Konum",text:msg});
      writeLog("ğŸ“¤ WhatsApp/Share ekranÄ± aÃ§Ä±ldÄ± âœ”");
    } catch { writeLog("Share iptal edildi âŒ"); }
  } else {
    writeLog("ğŸ“¤ Share API yok â†’ Link/mesaj rehbere SMS ile gitti.");
  }
}

function panicConfirm(){
  const p=JSON.parse(LS.getItem("profile"));
  document.getElementById("confirm1btn").innerText=`ğŸ“ ${p.acil1.ad}`;
  document.getElementById("confirm2btn").innerText=p.acil2?`ğŸ“ ${p.acil2.ad}`:"";
  showPanel("confirmBox");
}

function call112(){ location.href="tel:112"; }
function closeSettings(){ showPanel("mainPanel"); }

// Pil ve konum izleme loglarÄ± UIâ€™a yazÄ±lÄ±r
function startLoops(){
  if(!navigator.getBattery){ writeLog("Pil API yok âŒ"); return; }
  navigator.getBattery().then(b=>{
    setInterval(()=>{
      const lvl=Math.round(b.level*100);
      writeLog("ğŸ”‹ Pil: %" + lvl);
      const p=JSON.parse(LS.getItem("profile"));
      if(lvl<=5) sendShare(p.acil1.tel,p.ad);
      if(lvl<=1) sendShare(p.acil1.tel,p.ad);
    },5*60*1000);
  });

  navigator.geolocation?.watchPosition(p=>{
    writeLog(`ğŸ“ Konum: ${p.coords.latitude},${p.coords.longitude}`);
  });
}

// Ayarlar panelini aÃ§
function openSettings(){
  const p = JSON.parse(LS.getItem("profile") || "{}");
  const perms = JSON.parse(LS.getItem("izinler") || "{}");
  document.getElementById("settingsProfile").innerText = JSON.stringify(p,null,2);
  document.getElementById("settingsPerms").innerText = JSON.stringify(perms,null,2);
  showPanel("settingsPanel");
}

// Profili dÃ¼zenle
function editProfile(){
  const p = JSON.parse(LS.getItem("profile")||"{}");
  document.getElementById("ad").value = p.ad || "";
  document.getElementById("acil1ad").value = p.acil1?.ad || "";
  document.getElementById("acil1tel").value = p.acil1?.tel || "";
  document.getElementById("acil2ad").value = p.acil2?.ad || "";
  document.getElementById("acil2tel").value = p.acil2?.tel || "";
  showPanel("profilePanel");
}
</script>

</body>
</html>
