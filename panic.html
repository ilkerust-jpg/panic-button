<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>HG Acil</title>
<style>
body{font-family:sans-serif;padding:18px;margin:0;background:#fff;color:#111;text-align:center}
#panicBtn{width:100%;padding:22px;font-size:21px;background:#d33;color:#fff;border:none;border-radius:12px;font-weight:600;cursor:pointer;margin-top:14px}
.menuBtn{padding:12px;font-size:15px;border-radius:8px;background:#222;color:#fff;border:none;cursor:pointer;flex:1}
.contactBtn{width:100%;padding:16px;font-size:17px;background:#222;color:#fff;border:none;border-radius:10px;margin-top:10px;font-weight:600;cursor:pointer}
#logBox{background:#000;color:#fff;font-size:14px;padding:12px;border-radius:8px;margin-top:14px;min-height:40px;white-space:pre-wrap;text-align:left}
.warn{background:#ffefc2;padding:10px;border-left:4px solid #e6a700;border-radius:6px;margin-top:12px;font-size:13px;color:#b00;text-align:left}
.panel{display:none;background:#eee;padding:14px;border-radius:10px;margin-top:14px;text-align:left;font-size:14px;width:100%}
input{width:100%;padding:10px;font-size:15px;border-radius:6px;border:1px solid #444;margin-top:4px}
</style>
</head>
<body>

<h2>HG Acil Durum</h2>

<div class="topbar" style="display:flex;gap:8px;margin-bottom:12px">
  <button id="btnSettings" class="menuBtn">âš™ Ayarlar</button>
  <button id="btnPerms" class="menuBtn">ğŸ“Œ Ä°zinler</button>
</div>

<button id="panicBtn">ğŸš¨ ACÄ°L</button>

<div id="contacts"></div>

<h3>Durum</h3>
<div id="logBox">Sistem bekliyorâ€¦</div>

<div id="warnings"></div>

<!-- Ä°ZÄ°N PANEL -->
<div id="permPanel" class="panel">
  <h3>Ä°zinler</h3>
  <button id="permGPS">ğŸ“ Konum</button>
  <button id="permNotif">ğŸ”” Bildirim</button>
  <button id="permMotion">ğŸ“± Ä°vme/Hareket</button>
  <button id="permBT">âŒš Bluetooth</button>
  <button id="permSMS">âœ‰ SMS</button>
  <button id="permClose">Kapat</button>
  <div id="permResult" class="warn"></div>
</div>

<!-- PROFÄ°L PANEL -->
<div id="profilePanel" class="panel">
  <h3>Profil</h3>
  <label>Ad Soyad</label>
  <input id="ad"/>
  <label>Acil KiÅŸi 1</label>
  <input id="acil1ad"/>
  <input id="acil1tel"/>
  <label>Acil KiÅŸi 2 (opsiyon)</label>
  <input id="acil2ad"/>
  <input id="acil2tel"/>
  <button id="profileSave">Kaydet & BaÅŸlat</button>
  <button id="profileClose">Kapat</button>
</div>

<!-- ACÄ°L ONAY PANEL -->
<div id="confirmPanel" class="panel">
  <h3>112 Arama</h3>
  <button id="call112">112'yi Ara</button>
  <button id="cancel112">Ä°ptal</button>
</div>

<script>
const LS = localStorage;

// Log kutusunu max 2 satÄ±rda tut
let logLines=[];
function updateLog(m){
  if(logLines.length>=2) logLines.shift();
  logLines.push(m);
  document.getElementById("logBox").innerText = logLines.join("\n");
  console.log(m);
}

// UyarÄ± ekle
function warn(m){
  document.getElementById("warnings").innerHTML += `<div class="warn">${m}</div>`;
}

// Ä°zin storage init
let izin = JSON.parse(LS.getItem("izin")||`{"gps":false,"motion":false,"notif":false,"bt":false,"sms":false}`);

// Ä°zin panel kontroller
btnPerms.onclick = ()=>permPanel.style.display="block";
permClose.onclick = ()=>permPanel.style.display="none";
permClose.style.cursor="pointer";
permClose.innerText="Kapat";

// Profil panel kontroller
btnSettings.onclick = ()=>{
  const p=JSON.parse(LS.getItem("profile")||"{}");
  document.getElementById("ad").value = p.ad||"";
  profilePanel.style.display="block";
};
profileClose.onclick = ()=>profilePanel.style.display="none";
profileClose.style.cursor="pointer";
profileClose.innerText="Kapat";

// Ä°zin butonlarÄ± baÄŸlama
permGPS.onclick = ()=>navigator.geolocation?.getCurrentPosition(p=>{
  izin.gps=true;
  LS.setItem("izin",JSON.stringify(izin));
  document.getElementById("permResult").innerText="Konum izni alÄ±ndÄ± âœ”";
  updateLog("ğŸ“ "+p.coords.latitude+","+p.coords.longitude);
},()=>warn("Konum izni yok âŒ"));

permMotion.onclick = async ()=>{
  if(typeof DeviceMotionEvent?.requestPermission==="function"){
    const r=await DeviceMotionEvent.requestPermission();
    izin.motion=r==="granted";
  } else izin.motion=true;
  LS.setItem("izin",JSON.stringify(izin));
  document.getElementById("permResult").innerText="Ä°vme/Hareket izni âœ”";
  updateLog("ğŸ“± Ä°vme sensÃ¶r aktif âœ”");
};

permBT.onclick = async ()=>{
  try{await navigator.bluetooth.requestDevice({acceptAllDevices:true});izin.bt=true;}catch{}
  LS.setItem("izin",JSON.stringify(izin));
  document.getElementById("permResult").innerText="Bluetooth izni âœ”";
  updateLog("âŒš Bluetooth aktif âœ”");
};

permSMS.onclick = ()=>{izin.sms=true;LS.setItem("izin",JSON.stringify(izin));updateLog("âœ‰ SMS aktif âœ”")};
permNotif.onclick = async ()=>{const r=await Notification?.requestPermission();izin.notif=r==="granted";LS.setItem("izin",JSON.stringify(izin));updateLog("ğŸ”” Bildirim:"+r)};

// Profil kaydetme butonu
profileSave.onclick = ()=>{
  const ad=document.getElementById("ad").value.trim();
  const a1=document.getElementById("acil1ad").value.trim();
  const t1=document.getElementById("acil1tel").value.trim();
  const a2=document.getElementById("acil2ad").value.trim();
  const t2=document.getElementById("acil2tel").value.trim();
  if(!ad||!a1||!t1) return warn("Profil eksik â—");
  const obj={ad,acil1:{ad:a1,tel:t1},acil2:a2&&t2?{ad:a2,tel:t2}:null};
  LS.setItem("profile",JSON.stringify(obj));
  profilePanel.style.display="none";
  permPanel.style.display="none";
  bindContacts();
  updateLog("Profil yÃ¼klendi âœ”");
};

// KiÅŸileri storageâ€™dan yÃ¼kle
function bindContacts(){
  const p=JSON.parse(LS.getItem("profile")||"null");
  if(!p) return;
  contacts.innerHTML =
    `<button class="contactBtn" onclick="callAcil(1)">Acil 1: ${p.acil1.ad}</button>`+
    (p.acil2?`<button class="contactBtn" onclick="callAcil(2)">Acil 2: ${p.acil2.ad}</button>`:"");
}

// Acil kiÅŸi akÄ±ÅŸÄ±
window.callAcil = function(n){
  const p=JSON.parse(LS.getItem("profile"));
  const c=n===1?p.acil1:p.acil2;
  if(!c?.tel) return warn("Acil kiÅŸi yok âŒ");
  updateLog("ğŸ“ "+c.ad+" aranÄ±yorâ€¦");
  location.href="tel:"+c.tel;
  navigator.geolocation?.getCurrentPosition(pos=>{
    const loc="https://maps.google.com/?q="+pos.coords.latitude+","+pos.coords.longitude;
    const msg=`ğŸš¨ ACÄ°L | ${p.ad}\nKonum: ${loc}`;
    if(izin.sms) location.href="sms:"+c.tel+"?body="+encodeURIComponent(msg);
    navigator.share?.({title:"Acil",text:msg});
  });
}

// 112 panel akÄ±ÅŸÄ±
panicBtn.onclick = ()=>confirmPanel.style.display="block";
call112.onclick = ()=>location.href="tel:112";
cancel112.onclick = ()=>confirmPanel.style.display="none";

// Ä°lk aÃ§Ä±lÄ±ÅŸta profil varsa baÄŸla
window.onload = ()=>{ if(LS.getItem("profile")){bindContacts();updateLog("Sistem hazÄ±r âœ”");} }
</script>

</body>
</html>
