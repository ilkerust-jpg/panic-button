<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>HG Acil</title>
<style>
body{font-family:sans-serif;padding:20px;margin:0;background:#fff;color:#111}
input{width:100%;padding:12px;font-size:16px;border-radius:8px;border:1px solid #555;margin-top:6px}
button{width:100%;padding:18px;font-size:18px;background:#c00;color:#fff;border:none;border-radius:10px;margin-top:12px;font-weight:600;cursor:pointer}
button.alt{background:#222}
.alert{background:#fff3cd;border-left:4px solid #ffb300;padding:12px;border-radius:6px;margin-top:12px;font-size:14px}
.panel{padding:16px;background:#f2f2f2;border-radius:10px;margin-bottom:14px}
#panicBtn{background:#c00;font-size:22px;padding:26px;border-radius:12px;width:100%;font-weight:700}
#confirmBox{display:none;position:fixed;top:30%;left:5%;width:90%;background:#fff;padding:16px;border-radius:12px;box-shadow:0 0 16px rgba(0,0,0,0.3)}
#settingsPanel{display:none}
#profilePanel{display:none}
#permPanel{display:none}
#mainPanel{display:none}
</style>
</head>
<body>

<h2>HÄ±zÄ±r Gibi â€” Acil GÃ¼ven</h2>

<!-- Ãœst menÃ¼ sabit -->
<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px">
  <button class="alt" onclick="openSettings()">âš™ Ayarlar</button>
  <button class="alt" onclick="showPanel('permPanel')">ğŸ“Œ Ä°zinler</button>
</div>

<!-- Ä°zin Paneli -->
<div id="permPanel" class="panel">
  <h3>Gerekli Ä°zinler</h3>
  <button onclick="requestGPS()">ğŸ“ Konum izni</button>
  <button onclick="requestMotion()">ğŸ“± Ä°vme sensÃ¶rÃ¼ izni</button>
  <button onclick="requestNotif()">ğŸ”” Bildirim izni</button>
  <button onclick="requestBT()" class="alt">âŒš Bluetooth izni</button>
  <div id="permResult" class="row"></div>
  <button onclick="permissionsDone()" class="alt">Ä°zinler tamamlandÄ±</button>
</div>

<!-- Profil Paneli -->
<div id="profilePanel" class="panel">
  <h3>Acil Profil</h3>
  <div id="deviceBox" style="font-size:13px;color:#333;margin-bottom:8px"></div>

  <div class="row">
    <label>KullanÄ±cÄ± (Ad Soyad)</label>
    <input id="ad" placeholder="Ad Soyad"/>
  </div>

  <div class="row">
    <label>Acil KiÅŸi 1 (Ä°sim)</label>
    <input id="acil1ad" placeholder="Ã–rn: Ahmet YÄ±lmaz"/>
  </div>
  <div class="row">
    <label>Acil KiÅŸi 1 (Telefon)</label>
    <input id="acil1tel" placeholder="05xx xxx xx xx"/>
  </div>

  <div class="row">
    <label>Acil KiÅŸi 2 (Ä°sim)</label>
    <input id="acil2ad" placeholder="Opsiyonel"/>
  </div>
  <div class="row">
    <label>Acil KiÅŸi 2 (Telefon)</label>
    <input id="acil2tel" placeholder="Opsiyonel"/>
  </div>

  <button onclick="saveProfile()">Kaydet & BaÅŸlat</button>
</div>

<!-- Ana Sistem Paneli -->
<div id="mainPanel" class="panel">
  <h3>Sistem Durumu</h3>
  <div id="statusBox" class="alert">ğŸ“¡ Sistem baÅŸlatÄ±lmadÄ±â€¦</div>

  <button onclick="callEmergency(1)" id="acil1btn" style="display:none"></button>
  <button onclick="callEmergency(2)" id="acil2btn" style="display:none"></button>
  <button id="panicBtn" onclick="panicConfirm()">ACÄ°L</button>
</div>

<!-- Panik Onay Paneli -->
<div id="confirmBox">
  <div id="confirmText"></div>
  <button onclick="call112()" class="row">ğŸ“ 112â€™yi Ara</button>
  <button onclick="callEmergency(1)" id="confirm1btn" class="row"></button>
  <button onclick="callEmergency(2)" id="confirm2btn" class="row"></button>
  <button onclick="closeConfirm()" class="alt row">Ä°ptal</button>
</div>

<script>
const LS = localStorage;
let izinler = JSON.parse(LS.getItem("izinler") || '{"konum":false,"motion":false,"notif":false,"bt":false}');
LS.setItem("izinler", JSON.stringify(izinler));

async function getFP(){
  const data = navigator.userAgent + screen.width + screen.height + Intl.DateTimeFormat().resolvedOptions().timeZone;
  const hash = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(data));
  return [...new Uint8Array(hash)].map(b=>b.toString(16).padStart(2,"0")).join("");
}

function warn(msg){
  document.getElementById("alerts").innerHTML += `<div class="alert">${msg}</div>`;
}

function openSettings(){
  showPanel("settingsPanel");
  const perms = JSON.parse(LS.getItem("izinler"));
  document.getElementById("settingsPerms").innerText = JSON.stringify(perms, null, 2);
  if(!perms.konum) warn("Konum izni yok â†’ Konum paylaÅŸÄ±mÄ± Ã§alÄ±ÅŸmaz");
  if(!perms.notif) warn("Bildirim izni yok â†’ Bildirimler kapalÄ±");
  if(!perms.bt) warn("Bluetooth izni yok â†’ Saat fonksiyonu kapalÄ±");
  if(!perms.motion) warn("Ä°vme sensÃ¶rÃ¼ izni yok â†’ DÃ¼ÅŸme analizi kapalÄ±");
  document.getElementById("settingsProfile").innerText = LS.getItem("profile") || "HenÃ¼z profil kaydedilmemiÅŸ.";
}

function editProfile(){
  const p = JSON.parse(LS.getItem("profile")||"{}");
  document.getElementById("ad").value = p.ad || "";
  document.getElementById("acil1ad").value = p.acil1?.ad || "";
  document.getElementById("acil1tel").value = p.acil1?.tel || "";
  document.getElementById("acil2ad").value = p.acil2?.ad || "";
  document.getElementById("acil2tel").value = p.acil2?.tel || "";
  showPanel("profilePanel");
}

function closeSettings(){
  showPanel("mainPanel");
}

function showPanel(id){
  ["permPanel","profilePanel","mainPanel","settingsPanel","confirmBox"].forEach(p=>{
    document.getElementById(p).style.display="none";
  });
  document.getElementById(id).style.display="block";
}

function permissionsDone(){
  showPanel("profilePanel");
}

async function saveProfile(){
  const ad=document.getElementById("ad").value.trim();
  const acil1ad=document.getElementById("acil1ad").value.trim();
  const acil1tel=document.getElementById("acil1tel").value.trim();
  const acil2ad=document.getElementById("acil2ad").value.trim();
  const acil2tel=document.getElementById("acil2tel").value.trim();
  const fp = await getFP();

  if(!ad || !acil1ad || !acil1tel){
    return alert("KullanÄ±cÄ± adÄ±, Acil KiÅŸi 1 adÄ± ve telefonu zorunludur!");
  }

  LS.setItem("profile", JSON.stringify({
    ad,
    fp,
    acil1:{ad:acil1ad,tel:acil1tel},
    acil2: acil2ad && acil2tel ? {ad:acil2ad,tel:acil2tel} : null
  }));

  showMainUI();
}

function showMainUI(){
  const p = JSON.parse(LS.getItem("profile")||"{}");
  document.getElementById("statusBox").innerText = `ğŸ“¡ Sistem Aktif | KullanÄ±cÄ±: ${p.ad}`;
  document.getElementById("acil1btn").style.display="block";
  document.getElementById("acil1btn").innerText=`Acil 1: ${p.acil1.ad} â€” Ara & Konum + Mesaj GÃ¶nder`;
  if(p.acil2){
    document.getElementById("acil2btn").style.display="block";
    document.getElementById("acil2btn").innerText=`Acil 2: ${p.acil2.ad} â€” Ara & Konum + Mesaj GÃ¶nder`;
  } else {
    document.getElementById("acil2btn").style.display="none";
  }
  showPanel("mainPanel");
}

function panicConfirm(){
  const p = JSON.parse(LS.getItem("profile")||"{}");
  document.getElementById("confirmText").innerText =
    `ğŸš¨ ACÄ°L Tetiklendi!\nKullanÄ±cÄ±: ${p.ad}\nAcil 1: ${p.acil1.ad} â€” ${p.acil1.tel}\nAcil 2: ${p.acil2?.ad||"-"} â€” ${p.acil2?.tel||"-"}`;
  document.getElementById("confirmBox").style.display="block";
  document.getElementById("confirm1btn").innerText=`Acil 1: ${p.acil1.ad}`;
  document.getElementById("confirm2btn").innerText=`Acil 2: ${p.acil2?.ad||"KayÄ±tlÄ± deÄŸil"}`;
}

function callEmergency(n){
  const p = JSON.parse(LS.getItem("profile")||"{}");
  const t = n===1 ? p.acil1.tel : p.acil2?.tel;
  if(!t) return alert("Acil kiÅŸi telefon kaydÄ± yok!");
  location.href = `tel:${t}`;
  shareLocation(`Acil durum tahmini | ${p.ad}`, t);
}

function call112(){ location.href="tel:112"; }
function closeConfirm(){ document.getElementById("confirmBox").style.display="none"; }

async function shareLocation(msg, tel){
  if(!tel) return;
  navigator.geolocation.getCurrentPosition(p=>{
    const m = msg + ` | Konum: ${p.coords.latitude},${p.coords.longitude}`;
    location.href=`sms:${tel}?body=${encodeURIComponent(m)}`;
  });
}

window.onload = async ()=>{
  const p = LS.getItem("profile");
  if(p){
    showMainUI();
  } else {
    showPanel("permPanel");
  }
}
</script>

</body>
</html>
