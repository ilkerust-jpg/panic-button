<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>HG ACÄ°L</title>
<style>
  body{font-family:sans-serif;padding:18px;margin:0;background:#fff;color:#111;text-align:center}
  #panicBtn{width:90%;padding:24px;font-size:22px;background:#d00;color:#fff;border:none;border-radius:12px;font-weight:700;margin-top:12px;cursor:pointer}
  .contactBtn{width:90%;padding:16px;font-size:17px;background:#222;color:#fff;border:none;border-radius:10px;margin-top:10px;cursor:pointer;font-weight:600}
  #logBox{background:#000;color:#fff;font-size:14px;padding:12px;border-radius:8px;margin-top:14px;min-height:50px;white-space:pre-wrap}
  .warn{background:#ffefc2;padding:10px;border-left:3px solid #e6a700;border-radius:6px;margin-top:12px;font-size:13px;width:90%;margin-left:auto;margin-right:auto;text-align:left}
  #settingsPanel,#permPanel,#profilePanel,#confirmPanel{display:none;padding:14px;background:#f5f5f5;border-radius:10px;margin-top:14px;text-align:left;width:90%;margin-left:auto;margin-right:auto}
  .topbar{display:flex;gap:8px;margin-bottom:12px}
  .topbar button{padding:12px;font-size:15px;border-radius:8px;margin:0;background:#222;color:#fff;width:auto;flex:1;cursor:pointer}
  input{width:100%;padding:10px;font-size:15px;border-radius:6px;border:1px solid #444;margin-top:4px}
</style>
</head>
<body>

<h2>Acil Durum Ä°zleme</h2>

<div class="topbar">
  <button onclick="toggleSettings()">âš™ Ayarlar</button>
  <button onclick="togglePerms()">ğŸ“Œ Ä°zinler</button>
</div>

<button id="panicBtn" onclick="panic()">ACÄ°L</button>

<div id="contacts"></div>

<div><strong>CanlÄ± Log</strong><div id="logBox"></div></div>

<!-- AYARLAR PANEL -->
<div id="settingsPanel">
  <h3>âš™ Ayarlar</h3>
  <div id="settingsProfile" class="warn"></div>
  <div id="settingsPerms" class="warn"></div>
  <button onclick="editProfile()" class="alt">Profili DÃ¼zenle</button>
</div>

<!-- Ä°ZÄ°N PANEL -->
<div id="permPanel">
  <h3>Gerekli Ä°zinler</h3>
  <button onclick="requestGPS()">ğŸ“ Konum</button>
  <button onclick="requestNotif()">ğŸ”” Bildirim</button>
  <button onclick="requestBT()">âŒš Bluetooth</button>
  <button onclick="sensorCheck()">ğŸ“± SensÃ¶rleri Kontrol Et</button>
  <div id="permResult" class="warn"></div>
</div>

<!-- PROFÄ°L PANEL -->
<div id="profilePanel">
  <h3>Acil Profil</h3>
  <label>KullanÄ±cÄ± (Ad Soyad)</label>
  <input id="ad" placeholder="Ad Soyad">
  <label>Acil KiÅŸi 1 (Ä°sim)</label>
  <input id="acil1ad" placeholder="Acil kiÅŸi 1 isim">
  <label>Acil KiÅŸi 1 (Telefon)</label>
  <input id="acil1tel" placeholder="05xx xxx xx xx">
  <label>Acil KiÅŸi 2 (Ä°sim)</label>
  <input id="acil2ad" placeholder="Acil kiÅŸi 2 isim">
  <label>Acil KiÅŸi 2 (Telefon)</label>
  <input id="acil2tel" placeholder="05xx xxx xx xx">
  <button onclick="saveProfile()">Kaydet & BaÅŸlat</button>
</div>

<!-- CONFIRM PANEL -->
<div id="confirmPanel">
  <h3>ğŸš¨ Acil Onay</h3>
  <button onclick="call112()">112'yi Ara</button>
  <button onclick="triggerEmergency(1)" id="c1"></button>
  <button onclick="triggerEmergency(2)" id="c2"></button>
</div>

<script>
const LS = localStorage;

// Storage init
let izinler = JSON.parse(LS.getItem("izinler") || `{"gps":false,"notif":false,"bt":false}`);
LS.setItem("izinler", JSON.stringify(izinler));

// Unique fingerprint
async function getFP(){
  const raw = navigator.userAgent + screen.width + screen.height;
  const buf = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(raw));
  return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,"0")).join("");
}

// Log UI (max 2 satÄ±r)
function updateLogUI(m){
  document.getElementById("logBox").innerText = m;
}

// Sensor check
function sensorCheck(){
  let msg="ğŸ“¡ SensÃ¶r durumu:\n";
  msg += "Konum API: " + (navigator.geolocation?"Var âœ”":"Yok âŒ") + "\n";
  msg += "Bildirim API: " + (window.Notification?"Var âœ”":"Yok âŒ") + "\n";
  msg += "Bluetooth API: " + (navigator.bluetooth?"Var âœ”":"Yok âŒ");
  document.getElementById("permResult").innerText = msg;
}

// Toggle panels
function toggleSettings(){
  const p=document.getElementById("settingsPanel");
  if(p){
    const vis = p.style.display==="block"?"none":"block";
    p.style.display=vis;
    if(vis==="block") openSettings();
  }
}
function togglePerms(){
  const p=document.getElementById("permPanel");
  if(p) p.style.display = p.style.display==="block"?"none":"block";
}

// Ayarlar aÃ§
function openSettings(){
  const p=JSON.parse(LS.getItem("profile")||"{}");
  const perms=JSON.parse(LS.getItem("izinler")||"{}");
  document.getElementById("settingsProfile").innerText = p.ad ? `KullanÄ±cÄ±: ${p.ad}\nAcil 1: ${p.acil1?.ad} (${p.acil1?.tel})\nAcil 2: ${p.acil2?.ad||"â€”"}` : "Profil yok";
  document.getElementById("settingsPerms").innerText = `Konum: ${perms.gps?"AÃ§Ä±k":"KapalÄ±"} | Bildirim: ${perms.notif?"AÃ§Ä±k":"KapalÄ±"} | Bluetooth: ${perms.bt?"AÃ§Ä±k":"KapalÄ±"}`;
}

// Ä°zinler
function requestGPS(){
  navigator.geolocation?.getCurrentPosition(p=>{
    izinler.gps=true;
    LS.setItem("izinler",JSON.stringify(izinler));
    document.getElementById("permResult").innerText="ğŸ“ Konum izni alÄ±ndÄ± âœ” Lat:"+p.coords.latitude;
    updateLogUI("ğŸ“ "+p.coords.latitude+","+p.coords.longitude);
  },()=>document.getElementById("permResult").innerText="Konum izni yok âŒ");
}

async function requestNotif(){
  const r=await Notification?.requestPermission();
  izinler.notif = r==="granted";
  LS.setItem("izinler",JSON.stringify(izinler));
  document.getElementById("permResult").innerText = izinler.notif?"ğŸ”” Bildirim izni alÄ±ndÄ± âœ”":"Bildirim izni yok âŒ";
}

async function requestBT(){
  try{
    await navigator.bluetooth.requestDevice({acceptAllDevices:true});
    izinler.bt=true;
    LS.setItem("izinler",JSON.stringify(izinler));
    document.getElementById("permResult").innerText="âŒš Bluetooth izni alÄ±ndÄ± âœ”";
  }catch{document.getElementById("permResult").innerText="Bluetooth izni yok âŒ";}
}

// Profil doldurmayÄ± kaydet
async function saveProfile(){
  const ad=document.getElementById("ad").value.trim();
  const a1=document.getElementById("acil1ad").value.trim();
  const t1=document.getElementById("acil1tel").value.trim();
  const a2=document.getElementById("acil2ad").value.trim();
  const t2=document.getElementById("acil2tel").value.trim();
  if(!ad||!a1||!t1) return alert("Eksik alan âŒ");
  const fp=await getFP();
  const obj={ad,fp,acil1:{ad:a1,tel:t1},acil2:a2&&t2?{ad:a2,tel:a2}:null};
  LS.setItem("profile",JSON.stringify(obj));
  bindButtons();
  document.getElementById("confirm1btn").innerText=a1;
  document.getElementByid("c2").innerText=a2;
  alert("Kaydedildi âœ”");
}

// Acil akÄ±ÅŸ
async function triggerEmergency(n){
  const p=JSON.parse(LS.getItem("profile"));
  const c = n===1 ? p.acil1 : p.acil2;
  if(!c?.tel) return alert("Acil kiÅŸi yok âŒ");

  navigator.geolocation?.getCurrentPosition(pos=>{
    const loc=pos.coords.latitude+","+pos.coords.longitude;
    const msg=`ğŸš¨ ACÄ°L | ${p.ad}\nKonum: ${loc}\nHÄ±z: 0 m/s (test)`;
    location.href="tel:"+c.tel;
    location.href="sms:"+c.tel+"?body="+encodeURIComponent(msg);
    navigator.share?.({title:"Acil",text:msg});
    updateLogUI("ğŸ“¤ Mesaj gÃ¶nderildi âœ” " + c.ad);
  });
}

function call112(){ location.href="tel:112"; }
function panic(){ showPanel("confirmPanel"); }

// AÃ§Ä±lÄ±ÅŸta butonlarÄ± baÄŸla
function bindButtons(){
  const p=JSON.parse(LS.getItem("profile")||"{}");
  if(!p.ad) return;
  document.getElementById("contacts").innerHTML =
    `<button class="contactBtn" onclick="triggerEmergency(1)">Acil 1: ${p.acil1.ad}</button>` +
    (p.acil2?`<button class="contactBtn" onclick="triggerEmergency(2)">Acil 2: ${p.acil2.ad}</button>`:"");
}

window.onload = ()=>{
  if(LS.getItem("profile")) bindButtons();
  updateLogUI("Sistem hazÄ±r âœ”");
}
</script>

</body>
</html>
