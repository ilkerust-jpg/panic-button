<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>HG ACÄ°L</title>
<style>
  body{font-family:sans-serif;padding:18px;margin:0;background:#fff;color:#111;text-align:center}
  #panicBtn{width:100%;padding:22px;font-size:21px;background:#d33;color:#fff;border:none;border-radius:12px;margin-top:14px;font-weight:600;cursor:pointer}
  .contactBtn{width:100%;padding:16px;font-size:17px;background:#222;color:#fff;border:none;border-radius:10px;margin-top:10px;cursor:pointer;font-weight:600}
  #logBox{background:#000;color:#fff;font-size:14px;padding:12px;border-radius:8px;margin-top:14px;min-height:50px;white-space:pre-wrap}
  .warn{background:#ffefc2;padding:10px;border-left:3px solid #e6a700;border-radius:6px;margin-top:12px;font-size:13px;width:100%;text-align:left}
  #settingsPanel,#permPanel,#profilePanel,#confirmPanel{display:none;padding:14px;background:#f5f5f5;border-radius:10px;margin-top:14px;text-align:left;width:100%}
  .topbar{display:flex;gap:8px;margin-bottom:12px}
  .topbar button{padding:12px;font-size:15px;border-radius:8px;margin:0;background:#222;color:#fff;width:auto;flex:1;cursor:pointer}
</style>
</head>
<body>

<h2>Acil Durum Ä°zleme</h2>

<div class="topbar">
  <button onclick="toggleSettings()">âš™ Ayarlar</button>
  <button onclick="togglePerms()">ğŸ“Œ Ä°zinler</button>
</div>

<button id="panicBtn" onclick="panic()">ACÄ°L</button>

<div id="contacts"></div>

<div><strong>CanlÄ± Log</strong><div id="logBox"></div></div>

<!-- AYARLAR -->
<div id="settingsPanel">
  <h3>âš™ Ayarlar</h3>
  <div id="settingsProfile" class="warn"></div>
  <div id="settingsPerms" class="warn"></div>
  <button class="alt" onclick="editProfile()">âœ Profili DÃ¼zenle</button>
  <button class="alt" onclick="closeSettings()">â¬… Ana Ekrana DÃ¶n</button>
</div>

<!-- Ä°ZÄ°NLER -->
<div id="permPanel">
  <h3>Gerekli Ä°zinler</h3>
  <button onclick="requestGPS()">ğŸ“ Konum izni</button>
  <button onclick="requestMotion()">ğŸ“± Ä°vme sensÃ¶rÃ¼ izni</button>
  <button onclick="requestNotif()">ğŸ”” Bildirim izni</button>
  <button onclick="requestBT()">âŒš Bluetooth izni</button>
  <div id="permResult" class="warn"></div>
  <button onclick="togglePerms()" class="alt">Kapat</button>
</div>

<!-- PROFÄ°L -->
<div id="profilePanel">
  <h3>Acil Profil</h3>
  <input id="ad" placeholder="Ad Soyad"/>
  <input id="acil1ad" placeholder="Acil kiÅŸi 1 isim"/>
  <input id="acil1tel" placeholder="Acil kiÅŸi 1 telefon"/>
  <input id="acil2ad" placeholder="Acil kiÅŸi 2 isim"/>
  <input id="acil2tel" placeholder="Acil kiÅŸi 2 telefon"/>
  <button onclick="saveProfile()">Kaydet & BaÅŸlat</button>
</div>

<script>
const LS = localStorage;

function toggleSettings(){
  const p=document.getElementById("settingsPanel");
  if(p) p.style.display=p.style.display==="block"?"none":"block";
  if(p.style.display==="block") openSettings();
}

function closeSettings(){ document.getElementById("settingsPanel").style.display="none"; }

function togglePerms(){
  const p=document.getElementById("permPanel");
  if(p) p.style.display=p.style.display==="block"?"none":"block";
}

let izinler = JSON.parse(LS.getItem("izinler") || `{"gps":false,"motion":false,"notif":false,"bt":false,"sms":false}`);

async function requestMotion(){
  if(!window.DeviceMotionEvent) return;
  if(typeof DeviceMotionEvent.requestPermission==="function"){
    const r=await DeviceMotionEvent.requestPermission();
    if(r==="granted") izinler.motion=true;
  } else izinler.motion=true;
  LS.setItem("izinler",JSON.stringify(izinler));
}

async function requestGPS(){
  navigator.geolocation?.getCurrentPosition(p=>{
    izinler.gps=true;
    LS.setItem("izinler",JSON.stringify(izinler));
    document.getElementById("permResult").innerText="ğŸ“ Konum izni alÄ±ndÄ± âœ” Lat:"+p.coords.latitude;
  });
}

async function requestNotif(){
  const r=await Notification?.requestPermission();
  if(r==="granted") izinler.notif=true;
  LS.setItem("izinler",JSON.stringify(izinler));
}

async function requestBT(){
  try{ await navigator.bluetooth?.requestDevice({acceptAllDevices:true}); izinler.bt=true; }
  catch{}
  LS.setItem("izinler",JSON.stringify(izinler));
}

async function saveProfile(){
  const ad=document.getElementById("ad").value.trim();
  const a1=document.getElementById("acil1ad").value.trim();
  const t1=document.getElementById("acil1tel").value.trim();
  const a2=document.getElementById("acil2ad").value.trim();
  const t2=document.getElementById("acil2tel").value.trim();
  if(!ad||!a1||!t1) return alert("Eksik alan âŒ");
  const fp = await getFP();
  const obj={ad,fp,acil1:{ad:a1,tel:t1},acil2:a2&&t2?{ad:a2,tel:a2}:null};
  LS.setItem("profile",JSON.stringify(obj));
  LS.setItem("izinler",JSON.stringify(izinler));
  bindButtons();
  alert("Kaydedildi âœ”");
}

function panic(){ location.href="tel:112"; }

function acil(n){
  const p=JSON.parse(LS.getItem("profile"));
  const c = n===1 ? p.acil1 : p.acil2;
  if(!c?.tel) return alert("Acil kiÅŸi yok âŒ");
  location.href="tel:"+c.tel;
  navigator.geolocation?.getCurrentPosition(pos=>{
    const locLink = "https://maps.google.com/?q=" + pos.coords.latitude + "," + pos.coords.longitude;
    const msg=`ğŸš¨ ACÄ°L | ${p.ad}\nKonum: ${locLink}\nHÄ±z: 0 m/s (test)\nÄ°vme: 0 g (test)`;
    location.href="sms:"+c.tel+"?body="+encodeURIComponent(msg);
    navigator.share?.({title:"Acil",text:msg});
    updateLogUI("ğŸ“¤ Mesaj gÃ¶nderildi âœ” " + c.ad);
  });
}

let logLines=[];
function updateLogUI(m){
  if(logLines.length>=2) logLines.shift();
  logLines.push(m);
  document.getElementById("logBox").innerText = logLines.join("\n");
}

function editProfile(){ showPanel("profilePanel"); }

window.onload = ()=>{ if(LS.getItem("profile")) bindButtons(); }

function bindButtons(){
  const p=JSON.parse(LS.getItem("profile")||"{}");
  if(!p.ad) return;
  document.getElementById("contacts").innerHTML =
    `<button class="contactBtn" onclick="acil(1)">Acil 1: ${p.acil1.ad}</button>` +
    (p.acil2?`<button class="contactBtn" onclick="acil(2)">Acil 2: ${p.acil2.ad}</button>`:"");
}
</script>

</body>
</html>
