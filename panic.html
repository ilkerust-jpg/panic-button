<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>HG Acil</title>
<style>
body{font-family:sans-serif;padding:20px;margin:0;background:#fff;color:#111}
input{width:100%;padding:12px;font-size:16px;border-radius:8px;border:1px solid #555;margin-top:6px}
button{width:100%;padding:18px;font-size:18px;background:#c00;color:#fff;border:none;border-radius:10px;margin-top:12px;font-weight:600;cursor:pointer}
button.alt{background:#222}
.alert{background:#fff3cd;border-left:4px solid #ffb300;padding:12px;border-radius:6px;margin-top:12px;font-size:14px}
.panel{padding:16px;background:#f2f2f2;border-radius:10px;margin-bottom:14px}
#panicBtn{background:#c00;font-size:22px;padding:26px;border-radius:12px;width:100%;font-weight:700}
#confirmBox{display:none;position:fixed;top:30%;left:5%;width:90%;background:#fff;padding:16px;border-radius:12px;box-shadow:0 0 16px rgba(0,0,0,0.3)}
</style>
</head>
<body>

<h2>HÄ±zÄ±r Gibi â€” Acil GÃ¼ven</h2>
<div id="alerts"></div>

<!-- Ä°zin Paneli -->
<div id="permPanel" class="panel">
  <h3>Gerekli Ä°zinler</h3>
  <button onclick="requestGPS()">ğŸ“ Konum izni ver</button>
  <button onclick="requestNotif()">ğŸ”” Bildirim izni ver</button>
  <button onclick="requestBT()" class="alt">âŒš Bluetooth (opsiyonel)</button>
  <button onclick="checkSensors()" class="alt">ğŸ“± Ä°vme sensÃ¶rÃ¼ kontrol</button>
  <div id="sensorResult" style="margin-top:10px;font-size:14px;color:#333"></div>
  <button onclick="permissionsDone()" class="alt">Ä°zinler tamamlandÄ±</button>
</div>

<!-- Profil Paneli -->
<div id="profilePanel" class="panel" style="display:none">
  <h3>Acil Profil</h3>
  <div id="deviceBox" style="font-size:13px;color:#333;margin-bottom:8px"></div>

  <label>KullanÄ±cÄ±</label>
  <input id="ad" placeholder="Ad Soyad"/>

  <label>Acil KiÅŸi 1 (Ä°sim)</label>
  <input id="name1" value="Ahmet YÄ±lmaz" disabled/>

  <label>Acil KiÅŸi 1 (Telefon)</label>
  <input id="tel1" placeholder="05xx xxx xx xx"/>

  <label>Acil KiÅŸi 2 (Ä°sim)</label>
  <input id="name2" value="AyÅŸe YÄ±ldÄ±z" disabled/>

  <label>Acil KiÅŸi 2 (Telefon)</label>
  <input id="tel2" placeholder="05xx xxx xx xx"/>

  <button onclick="saveProfile()">Kaydet & BaÅŸlat</button>
  <button onclick="openSettings()" class="alt">Ayarlar</button>
</div>

<!-- Ana Panel -->
<div id="mainPanel" class="panel" style="display:none">
  <h3>Sistem Aktif</h3>
  <div id="status" class="alert">ğŸ“¡ Ä°zleme baÅŸlatÄ±lÄ±yorâ€¦</div>
  <button id="panicBtn" onclick="panicConfirm()">ACÄ°L</button>
</div>

<!-- Onay Paneli -->
<div id="confirmBox">
  <div id="confirmText"></div>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px">
    <button onclick="call112()">ğŸ“ 112</button>
    <button onclick="callEmergency(1)">ğŸ‘¤ Acil 1: Ahmet YÄ±lmaz</button>
    <button onclick="callEmergency(2)">ğŸ‘¤ Acil 2: AyÅŸe YÄ±ldÄ±z</button>
    <button onclick="closeConfirm()" class="alt">Ä°ptal</button>
  </div>
</div>

<script>
const LS = localStorage;

// Ä°zinleri yÃ¼kle veya default oluÅŸtur
let izinler = JSON.parse(LS.getItem("izinler") || '{"konum":false,"notif":false,"bt":false}');
LS.setItem("izinler", JSON.stringify(izinler));

// Fingerprint Ã¼ret
async function getFP(){
  const data = navigator.userAgent + screen.width + screen.height + Intl.DateTimeFormat().resolvedOptions().timeZone;
  const hash = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(data));
  return [...new Uint8Array(hash)].map(b=>b.toString(16).padStart(2,"0")).join("");
}

// UyarÄ± bas
function warnUI(msg){
  document.getElementById("alerts").innerHTML += `<div class="alert">âš  ${msg}</div>`;
}

// Panel geÃ§iÅŸi
function showPanel(id){
  document.getElementById("permPanel").style.display="none";
  document.getElementById("profilePanel").style.display="none";
  document.getElementById("mainPanel").style.display="none";
  document.getElementById(id).style.display="block";
}

// Ä°zin panelini kapatÄ±p profile geÃ§
async function permissionsDone(){
  const fp = await getFP();
  document.getElementById("deviceBox").innerText = "Cihaz KimliÄŸi: " + fp;
  showPanel("profilePanel");
}

// Konum izni
async function requestGPS(){
  navigator.geolocation.getCurrentPosition(async ()=>{
    izinler.konum = true;
    LS.setItem("izinler", JSON.stringify(izinler));
    console.log("Konum izni alÄ±ndÄ± âœ”");
  }, ()=>{
    warnUI("Konum izni verilmedi â†’ Konum fonksiyonu kapalÄ±.");
  });
}

// Bildirim izni
async function requestNotif(){
  const r = await Notification.requestPermission();
  if(r==="granted"){
    izinler.notif=true;
    LS.setItem("izinler", JSON.stringify(izinler));
    document.getElementByid("status").innerText="ğŸ”” Bildirim izni alÄ±ndÄ±";
  } else {
    warnUI("Bildirim izni yok â†’ Bildirim fonksiyonu kapalÄ± olur.");
  }
}

// Bluetooth (opsiyonel)
async function requestBT(){
  if(!navigator.bluetooth){
    warnUI("Bluetooth desteklenmiyor â†’ saat entegrasyonu kapalÄ± olur.");
    return;
  }
  try{
    await navigator.bluetooth.requestDevice({acceptAllDevices:true});
    izinler.bt=true;
    LS.setItem("izinler", JSON.stringify(izinler));
    document.getElementByid("status").innerText="âŒš Bluetooth izni alÄ±ndÄ±";
  }catch{
    warnUI("Bluetooth izni verilmedi â†’ saat verisi kapalÄ± olur.");
  }
}

// SensÃ¶r kontrolÃ¼ UIâ€™a yaz
function checkSensors(){
  if(!window.DeviceMotionEvent){
    document.getElementByid("sensorResult").innerText = "Ä°vme/Hareket sensÃ¶rÃ¼ desteklenmiyor â— Manuel ACÄ°L Ã§alÄ±ÅŸÄ±r";
  } else {
    document.getElementByid("sensorResult").innerText = "Ä°vme sensÃ¶rÃ¼ destekleniyor âœ”";
  }
}

// Profil kaydet ve sistem baÅŸlat
async function saveProfile(){
  const ad=document.getElementByid("ad").value.trim();
  const tel1=document.getElementByid("tel1").value.trim();
  const tel2=document.getElementByid("tel2").value.trim();
  const fp = await getFP();

  if(!ad || !tel1){
    return alert("KullanÄ±cÄ± adÄ± ve en az 1 acil kiÅŸi telefonu zorunlu!");
  }

  LS.setItem("profile", JSON.stringify({ad,name1:"Ahmet YÄ±lmaz",tel1,name2:"AyÅŸe YÄ±ldÄ±z",tel2,fp}));
  showPanel("mainPanel");
  startLoops();
}

// DÃ¶ngÃ¼leri baÅŸlat
function startLoops(){
  if(izinler.konum) startGPSWatch();
  if(izinler.notif) console.log("Bildirimler aktif âœ”");
  startBatteryLoop();
}

// GPS izleme
function startGPSWatch(){
  navigator.geolocation.watchPosition(p=>{
    const {latitude, longitude, speed} = p.coords;
    const kmh = speed ? Math.round(speed*3.6) : 0;
    const msg = `ğŸ“ ${latitude.toFixed(5)}, ${longitude.toFixed(5)} | ${kmh} km/h`;
    document.getElementByid("status").innerText = msg;
  }, ()=> warnUI("Konum takibi durdu."), {enableHighAccuracy:true});
}

// Pil seviyesi izleme
function startBatteryLoop(){
  navigator.getBattery().then(b=>{
    b.onlevelchange = ()=>{
      const lvl = Math.round(b.level*100);
      console.log("Pil:", lvl);
      const p = JSON.parse(LS.getItem("profile")||"{}");
      if(lvl===5 || lvl===1){
        const msg = `ğŸ”‹ ÅarjÄ±m %${lvl} | KullanÄ±cÄ±: ${p.ad}`;
        if(p.tel1) location.href=`sms:${p.tel1}?body=${encodeURIComponent(msg)}`;
        if(p.tel2) location.href=`sms:${p.tel2}?body=${encodeURIComponent(msg)}`;
      }
    }
  });
}

// 112 ve acil kiÅŸiler arama
function callEmergency(n){
  const p = JSON.parse(LS.getItem("profile")||"{}");
  const tel = n===1 ? p.tel1 : p.tel2;
  if(!tel) return alert("Bu acil kiÅŸi kayÄ±tlÄ± deÄŸil!");
  location.href = `tel:${tel}`;
  if(p.tel1) location.href=`sms:${p.tel1}?body=${encodeURIComponent("ğŸ“ Acil konum paylaÅŸÄ±lÄ±yor...")}`;
  if(p.tel2) location.href=`sms:${p.tel2}?body=${encodeURIComponent("ğŸ“ Acil konum paylaÅŸÄ±lÄ±yor...")}`;
}

function call112(){ location.href="tel:112"; }
function closeConfirm(){ document.getElementByid("confirmBox").style.display="none"; }
</script>

</body>
</html>
